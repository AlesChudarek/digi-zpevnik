{% extends "dashboard_base.html" %}
{% block title %}Moje zpěvníky{% endblock %}

{% block content %}
<style>
  .grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 25px;
    padding: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .songbook-card {
    background: white;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s;
    text-align: center;
    text-decoration: none;
    color: #2E7D32;
    font-weight: bold;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .songbook-card:hover { transform: scale(1.05); }

  .songbook-card img { width: 100%; height: auto; }
  .songbook-card p { margin: 10px; padding: 0; color: var(--brand-strong, #2E7D32); }

  .songbook-title {
    margin: 10px;
    padding: 0;
    color: var(--brand-strong, #2E7D32);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }

  .songbook-actions {
    display: flex; justify-content: center; gap: 10px; padding: 10px 0 14px;
  }
  .songbook-actions .icon-btn {
    background: white; border: none; border-radius: 50%; width: 36px; height: 36px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.25); cursor: pointer; transition: transform 0.2s;
  }
  .songbook-actions .icon-btn:hover { transform: scale(1.08); }
  .songbook-actions .icon-btn img { width: 20px; height: 20px; display: block; margin: auto; }

  .add-card { cursor: pointer; }
  .add-card .cover {
    width: 100%;
    aspect-ratio: 1748 / 2480; /* match real cover proportions */
    background: #f1f1f1;
    border: 2px dashed #c8c8c8;
    box-sizing: border-box; /* ensure right border isn't clipped by parent overflow */
    display: flex; align-items: center; justify-content: center;
  }
  /* Themed plus icon via CSS mask colored by brand-strong */
  .add-card .plus-icon { width: 72px; height: 72px; background: var(--brand-strong, #2E7D32); }
  .add-card .plus-icon { -webkit-mask: url('{{ static_bust('img/icons/plus_circle.svg') }}') no-repeat center / contain; mask: url('{{ static_bust('img/icons/plus_circle.svg') }}') no-repeat center / contain; }
  .add-card:hover .cover { background: #eaeaea; }
</style>

<h1 style="text-align:center; margin-top: 30px;">Moje zpěvníky</h1>

<div class="grid-container">
  {% for book in songbooks|sort(attribute='id') %}
    <div class="songbook-card">
      <a href="{{ url_for('songbook_detail', book_id=book.id) }}" style="text-decoration:none; color:inherit;">
        {% if book.img_path_cover_preview %}
          <img src="{{ static_bust('songbooks/' + book.img_path_cover_preview) }}" alt="Náhled obalu">
        {% else %}
          <div style="width:100%; height:250px; background:#eee; display:flex; align-items:center; justify-content:center;">
            <span style="color: #888;">Bez obalu</span>
          </div>
        {% endif %}
        <p style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ book.title }}">{{ book.title }}</p>
      </a>
      <div class="songbook-actions">
        <span class="tooltip" data-tooltip="Upravit zpěvník">
          <button class="icon-btn" onclick="/* TODO: edit action */ event.preventDefault(); event.stopPropagation();">
            <img src="{{ static_bust('img/icons/edit.svg') }}" alt="Upravit">
          </button>
        </span>
        <span class="tooltip" data-tooltip="Smazat zpěvník">
          <button class="icon-btn" onclick="/* TODO: delete action */ event.preventDefault(); event.stopPropagation();">
            <img src="{{ static_bust('img/icons/bin.svg') }}" alt="Smazat">
          </button>
        </span>
      </div>
    </div>
  {% endfor %}

  <!-- Always render an Add card as the last tile -->
  <div class="songbook-card add-card" onclick="/* TODO: add songbook */">
    <div class="cover">
      <div class="plus-icon" aria-hidden="true"></div>
    </div>
    <p>Přidat zpěvník</p>
  </div>
</div>

<!-- Modal: Nový zpěvník (vizuál) -->
<style>
  #new-book-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 3000; overflow-y: auto; }
  #new-book-modal .modal-wrap { margin-top: 70px; }
  body.navbar-hidden #new-book-modal .modal-wrap { margin-top: 20px; }
  #new-book-modal .modal { background: white; color: var(--brand-dark, #1b5e20); width: min(880px, 92vw); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 24px 24px 22px; }
  #new-book-modal h2 { margin: 0 0 12px; }
  .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 10px 0 16px; }
  .form-row label { font-weight: 600; font-size: 14px; color: var(--brand-dark, #1b5e20); }
  .form-row input[type="text"] { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--muted-border, #dbeadf); box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); font-size: 14px; background: #fff; color: var(--brand-dark, #1b5e20); }
  .form-row input[type="text"]:focus { outline: 2px solid var(--brand-strong, #1565C0); outline-offset: 1px; border-color: var(--brand-strong, #1565C0); }
  .cover-enable { display: flex; align-items: center; gap: 10px; margin: 6px 0 6px; }
  .cover-enable label { color: var(--brand-dark, #1b5e20); font-weight: 600; }
  .cover-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 20px; }
  .field-file { display: flex; flex-direction: column; gap: 6px; }
  .dropzone { 
    border: 2px dashed #c8c8c8; 
    border-radius: 10px; 
    padding: 12px; 
    text-align: center; 
    color: #666; 
    background: #fafafa; 
    cursor: pointer; 
    transition: background 0.2s, border-color 0.2s; 
    max-width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .dropzone:hover { background: #f1f1f1; border-color: #a8a8a8; }
  .dropzone.filled { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #dbeadf); color: var(--brand-dark, #1b5e20); }
  .field-file input[type="file"] { display: none; }
  .dz-label { 
    font-size: 13px; 
    opacity: 0.9; 
    max-width: 400px; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    white-space: nowrap; 
    display: block;
    word-break: break-word;
  }
  .disabled-block { opacity: 0.4; pointer-events: none; }
  /* Unify section titles */
  .field-file > label:first-child { font-weight: 600; color: var(--brand-dark, #1b5e20); }

  /* 3D Book preview */
  .book-preview { box-sizing: border-box; margin-top: 12px; display: flex; justify-content: center; align-items: center; background: var(--brand-dark, #0f3a23); padding: 16px 24px; border-radius: 12px; overflow: visible; width: calc(100% - 24px); margin-right: 24px; }
  .book-scene { box-sizing: border-box; }
  .book-scene { --coverW: 120px; --gap: 8px; perspective: 900px; width: calc(var(--coverW) * 2 + var(--gap) + 40px); height: calc(var(--coverW) * 1.42 + 24px); display: flex; align-items: center; justify-content: center; overflow: visible; position: relative; }
  .book-scene { cursor: grab; }
  .book-scene.dragging { cursor: grabbing; }
  .book-scene { touch-action: none; }
  .book-anchor { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); transform-style: preserve-3d; }
  .book { position: relative; transform-style: preserve-3d; transform-origin: 50% 50%; will-change: transform; width: var(--gap); height: calc(var(--coverW) * 1.42); }
  .book-cover { position: absolute; top: 50%; width: var(--coverW); aspect-ratio: 1748 / 2480; border-radius: 8px; transform-style: preserve-3d; }
  /* Hinge each cover to the spine edges so inner edges meet at center */
  .book-cover.right { left: calc(var(--gap) / 2); transform-origin: left center;  transform: translateY(-50%) rotateY(28deg); }
  .book-cover.left  { right: calc(var(--gap) / 2); transform-origin: right center; transform: translateY(-50%) rotateY(-28deg); }
  .book-cover .face { position: absolute; inset: 0; backface-visibility: hidden; background-size: contain; background-repeat: no-repeat; background-position: center; border: 2px solid #ffffff; border-radius: 8px; background-color: #ffffff; }
  .book-cover .face.inner { transform: rotateY(180deg); }
  @keyframes spin-book { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

  /* Layout for book + color controls */
  .book-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; margin-top: 16px; }
  .book-row .book-preview { justify-self: stretch; }
  .book-tools { min-width: 260px; }
  .book-tools label { color: var(--brand-dark, #1b5e20); }
  @media (max-width: 820px) { .book-row { grid-template-columns: 1fr; } .book-tools { width: 100%; } }

  /* Range slider theming: light channel-tinted tracks, black thumbs */
  input[type="range"] { accent-color: #000; }
  /* WebKit */
  #col-r::-webkit-slider-runnable-track { background: #fde8e8; height: 6px; border-radius: 999px; }
  #col-g::-webkit-slider-runnable-track { background: #e8f8ea; height: 6px; border-radius: 999px; }
  #col-b::-webkit-slider-runnable-track { background: #e8eefc; height: 6px; border-radius: 999px; }
  input[type="range"]::-webkit-slider-thumb { background: #111; width: 14px; height: 14px; border-radius: 50%; margin-top: -4px; }
  /* Firefox */
  #col-r::-moz-range-track { background: #fde8e8; height: 6px; border-radius: 999px; }
  #col-g::-moz-range-track { background: #e8f8ea; height: 6px; border-radius: 999px; }
  #col-b::-moz-range-track { background: #e8eefc; height: 6px; border-radius: 999px; }
  input[type="range"]::-moz-range-thumb { background: #111; width: 14px; height: 14px; border: none; border-radius: 50%; }
  /* MS Edge legacy */
  #col-r::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-g::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-b::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-r::-ms-fill-lower, #col-r::-ms-fill-upper { background: #fde8e8; }
  #col-g::-ms-fill-lower, #col-g::-ms-fill-upper { background: #e8f8ea; }
  #col-b::-ms-fill-lower, #col-b::-ms-fill-upper { background: #e8eefc; }
  input[type="range"]::-ms-thumb { background: #111; border: none; }

  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
  .btn { background: white; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #cfe6d3); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #a7d7b0); }
  .btn:hover { filter: brightness(0.98); }
</style>

<div id="new-book-modal">
  <div class="modal-wrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nb-title">
      <h2 id="nb-title">Nový zpěvník</h2>
      <div class="form-row">
        <label for="nb-name">Název zpěvníku</label>
        <input type="text" id="nb-name" placeholder="např. Můj nový zpěvník">
      </div>

      <div class="cover-enable">
        <input type="checkbox" id="nb-use-cover" checked>
        <label for="nb-use-cover">Přidat obálku</label>
      </div>

      <div id="cover-config">
        <div class="cover-grid">
          <div class="field-file">
            <label>Přední obálka zvenku</label>
            <label class="dropzone" id="dz-front-outer">
              <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
              <input type="file" accept="image/*" id="file-front-outer">
            </label>
          </div>
          <div class="field-file">
            <label>Zadní obálka zvenku</label>
            <label class="dropzone" id="dz-back-outer">
              <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
              <input type="file" accept="image/*" id="file-back-outer">
            </label>
          </div>
          <div class="field-file">
            <label>Přední obálka zevnitř</label>
            <label class="dropzone" id="dz-front-inner">
              <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
              <input type="file" accept="image/*" id="file-front-inner">
            </label>
          </div>
          <div class="field-file">
            <label>Zadní obálka zevnitř</label>
            <label class="dropzone" id="dz-back-inner">
              <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
              <input type="file" accept="image/*" id="file-back-inner">
            </label>
          </div>
        </div>

        <div class="book-row">
          <div class="book-preview" id="book-preview">
            <div class="book-scene">
              <div class="book-anchor">
                <div class="book" id="book-3d">
                  <div class="book-cover left">
                    <div class="face outer" id="tex-back-outer"></div>
                    <div class="face inner" id="tex-back-inner"></div>
                  </div>
                  <div class="book-cover right">
                    <div class="face outer" id="tex-front-outer"></div>
                    <div class="face inner" id="tex-front-inner"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="book-tools" id="cover-color-tools" style="display:flex; flex-direction:column; gap:10px;">
            <label style="font-weight:600; font-size:14px;">Barva obálky</label>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">R</span>
              <input type="range" id="col-r" min="0" max="255" value="255">
              <input type="number" id="num-r" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">G</span>
              <input type="range" id="col-g" min="0" max="255" value="255">
              <input type="number" id="num-g" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">B</span>
              <input type="range" id="col-b" min="0" max="255" value="255">
              <input type="number" id="num-b" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="hex-row" style="display:grid; grid-template-columns: max-content 140px max-content; gap:8px; align-items:center;">
              <span style="font-size:12px;">HEX</span>
              <input type="text" id="hex-col" value="#ffffff" maxlength="7" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
              <div id="col-preview" style="width:28px; height:28px; border-radius:6px; border:1px solid #cfe6d3; background:#ffffff;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="nb-cancel">Zrušit</button>
        <button class="btn primary" id="nb-create">Vytvořit</button>
      </div>
    </div>
  </div>
</div>

  <script>
    // Open modal from the add-card
    document.addEventListener('DOMContentLoaded', () => {
      const addCard = document.querySelector('.add-card');
      const modal = document.getElementById('new-book-modal');
      const useCover = document.getElementById('nb-use-cover');
      const coverConfig = document.getElementById('cover-config');
      const scene = document.querySelector('.book-scene');
      const book = document.getElementById('book-3d');
      const colorTools = document.getElementById('cover-color-tools');
      const modalContent = document.querySelector('#new-book-modal .modal');

      let rafId = null;
      const DURATION_MS = 8000; // default full turn time
      const DEFAULT_SPEED = -360 / (DURATION_MS / 1000); // deg per second (author's default)
      const DEFAULT_MAG = Math.abs(DEFAULT_SPEED);
      let currentAngle = 0; // degrees
      let currentSpeed = DEFAULT_SPEED; // deg/s
      let lastTs = null;
      let easing = false;
      let easeStartTs = 0;
      const EASE_MS = 800; // ramp back to default speed after hold
      let easeFromSpeed = 0;
      let easeTargetSpeed = DEFAULT_SPEED;
      let holdTimeout = null;
      let dragging = false;
      let lastX = 0;
      let lastMoveTs = 0;
      let lastVelocity = 0; // deg/s estimated during drag
      let justDragged = false;
      let justDraggedTimer = null;

      function animate(ts) {
        if (!lastTs) lastTs = ts;
        const dt = (ts - lastTs) / 1000; // seconds
        lastTs = ts;

        // Ease back to default speed after user interaction
        if (easing) {
          const t = Math.min(1, (ts - easeStartTs) / EASE_MS);
          currentSpeed = easeFromSpeed + (easeTargetSpeed - easeFromSpeed) * t; // smooth to target with preserved sign
          if (t >= 1) easing = false;
        }

        // Integrate angle
        currentAngle += currentSpeed * dt;
        book.style.transform = `rotateY(${currentAngle}deg)`;
        rafId = requestAnimationFrame(animate);
      }

      function startAnim() {
        if (!rafId) {
          lastTs = null;
          currentSpeed = DEFAULT_SPEED;
          rafId = requestAnimationFrame(animate);
        }
      }

      function stopAnim() {
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
      }

      function resetColorToRandom() {
        const r = Math.floor(Math.random()*256), g = Math.floor(Math.random()*256), b = Math.floor(Math.random()*256);
        applyColor(r,g,b);
      }

      function resetUploads() {
        const pairs = [
          { dz: 'dz-front-outer', file: 'file-front-outer', face: 'tex-front-outer' },
          { dz: 'dz-back-outer',  file: 'file-back-outer',  face: 'tex-back-outer'  },
          { dz: 'dz-front-inner', file: 'file-front-inner', face: 'tex-front-inner' },
          { dz: 'dz-back-inner',  file: 'file-back-inner',  face: 'tex-back-inner'  },
        ];
        const defaultText = 'Klikni nebo přetáhni obrázek sem';
        pairs.forEach(p => {
          const dz = document.getElementById(p.dz);
          const input = document.getElementById(p.file);
          const face = document.getElementById(p.face);
          if (input) { input.value = ''; }
          if (face) { face.style.backgroundImage = ''; }
          if (dz) {
            dz.classList.remove('filled');
            const lab = dz.querySelector('.dz-label');
            if (lab) { lab.textContent = defaultText; lab.style.fontWeight = '600'; }
          }
        });
      }

      if (addCard) addCard.addEventListener('click', () => { modal.style.display = 'flex'; startAnim(); resetColorToRandom(); resetUploads(); justDragged = false; pointerDownOnOverlay = false; startedInsideContent = false; });
      document.getElementById('nb-cancel').addEventListener('click', () => { modal.style.display = 'none'; stopAnim(); resetColorToRandom(); resetUploads(); });
      // Close only if the click started on overlay and ended on overlay (no drag from content)
      let pointerDownOnOverlay = false;
      let startedInsideContent = false;
      modal.addEventListener('mousedown', (e) => { pointerDownOnOverlay = (e.target === modal); startedInsideContent = false; });
      modal.addEventListener('touchstart', (e) => { pointerDownOnOverlay = (e.target === modal); startedInsideContent = false; }, { passive: true });
      if (modalContent) {
        modalContent.addEventListener('mousedown', () => { startedInsideContent = true; pointerDownOnOverlay = false; });
        modalContent.addEventListener('touchstart', () => { startedInsideContent = true; pointerDownOnOverlay = false; }, { passive: true });
      }
      modal.addEventListener('click', (e) => {
        const shouldClose = (e.target === modal) && pointerDownOnOverlay && !dragging && !justDragged && !startedInsideContent;
        if (shouldClose) {
          modal.style.display = 'none';
          stopAnim();
          resetColorToRandom();
          resetUploads();
        }
        // reset flags after any click
        pointerDownOnOverlay = false;
        startedInsideContent = false;
      });

    // Color controls refs (declared before setCoverEnabled so it can use them)
    const faces = Array.from(document.querySelectorAll('.book-cover .face'));
    const rRange = document.getElementById('col-r');
    const gRange = document.getElementById('col-g');
    const bRange = document.getElementById('col-b');
    const rNum = document.getElementById('num-r');
    const gNum = document.getElementById('num-g');
    const bNum = document.getElementById('num-b');
    const hexInput = document.getElementById('hex-col');
    const colPreview = document.getElementById('col-preview');

    function setCoverEnabled(enabled) {
      coverConfig.classList.toggle('disabled-block', !enabled);
      coverConfig.querySelectorAll('input[type="file"]').forEach(inp => inp.disabled = !enabled);
      if (colorTools) colorTools.classList.toggle('disabled-block', !enabled);
      [rRange,gRange,bRange,rNum,gNum,bNum,hexInput].forEach(el => { if (el) el.disabled = !enabled; });
    }
    setCoverEnabled(useCover.checked);
    useCover.addEventListener('change', () => setCoverEnabled(useCover.checked));

    // Helpers to wire up dropzones and previews
    function bindFile(idInput, idDz, idTargetFace) {
      const input = document.getElementById(idInput);
      const dz = document.getElementById(idDz);
      const face = document.getElementById(idTargetFace);
      const label = dz.querySelector('.dz-label');

      function handleFiles(files) {
        if (!files || !files[0]) return;
        const file = files[0];
        const url = URL.createObjectURL(file);
        if (face) face.style.backgroundImage = `url('${url}')`;
        if (label) { label.textContent = file.name; label.style.fontWeight = '700'; }
        dz.classList.add('filled');
      }

      dz.addEventListener('click', () => input.click());
      input.addEventListener('change', (e) => handleFiles(e.target.files));
      ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.add('hover'); }));
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.remove('hover'); }));
      dz.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files && files.length) {
          input.files = files; // reflect into input
          handleFiles(files);
        }
      });
    }

    bindFile('file-front-outer', 'dz-front-outer', 'tex-front-outer');
    bindFile('file-back-outer', 'dz-back-outer', 'tex-back-outer');
    bindFile('file-front-inner', 'dz-front-inner', 'tex-front-inner');
    bindFile('file-back-inner', 'dz-back-inner', 'tex-back-inner');

    // Drag-to-rotate with inertia
    function onPointerDown(e) {
      dragging = true;
      lastX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
      lastMoveTs = performance.now();
      lastVelocity = 0;
      currentSpeed = 0; // pause auto-rotation during drag
      scene.classList.add('dragging');
      document.body.style.userSelect = 'none';
      // Listen globally so drag can continue outside
      window.addEventListener('mousemove', onPointerMove);
      window.addEventListener('touchmove', onPointerMove, { passive: false });
      e.preventDefault();
    }

    function onPointerMove(e) {
      if (!dragging) return;
      const now = performance.now();
      const x = e.clientX || (e.touches && e.touches[0]?.clientX) || lastX;
      const dx = x - lastX;
      lastX = x;
      const dt = Math.max(0.001, (now - lastMoveTs) / 1000);
      lastMoveTs = now;
      const SENS = 0.45; // deg per pixel
      currentAngle += dx * SENS;
      book.style.transform = `rotateY(${currentAngle}deg)`;
      // estimate velocity in deg/s, clamp
      const v = (dx * SENS) / dt;
      const MAX_V = 720;
      lastVelocity = Math.max(-MAX_V, Math.min(MAX_V, v));
      e.preventDefault();
    }

    function onPointerUp() {
      if (!dragging) return;
      dragging = false;
      scene.classList.remove('dragging');
      document.body.style.userSelect = '';
      window.removeEventListener('mousemove', onPointerMove);
      window.removeEventListener('touchmove', onPointerMove);
      // Fling with last velocity for 1s, then ease back
      currentSpeed = lastVelocity;
      if (holdTimeout) clearTimeout(holdTimeout);
      holdTimeout = setTimeout(() => {
        easing = true;
        easeStartTs = performance.now();
        easeFromSpeed = currentSpeed;
        // Set target speed to default magnitude but preserve user's last direction
        const dir = (easeFromSpeed === 0) ? Math.sign(DEFAULT_SPEED) || 1 : Math.sign(easeFromSpeed);
        easeTargetSpeed = dir * DEFAULT_MAG;
      }, 1000);
      // Prevent overlay click close immediately after drag end
      justDragged = true;
      if (justDraggedTimer) clearTimeout(justDraggedTimer);
      justDraggedTimer = setTimeout(() => { justDragged = false; }, 300);
    }

    // Prefer Pointer Events with capture; fallback to mouse/touch
    if (window.PointerEvent) {
      scene.addEventListener('pointerdown', (e) => { onPointerDown(e); try { scene.setPointerCapture(e.pointerId); } catch(_){} });
      scene.addEventListener('pointermove', onPointerMove);
      scene.addEventListener('pointerup', onPointerUp);
      scene.addEventListener('pointercancel', onPointerUp);
    } else {
      scene.addEventListener('mousedown', onPointerDown);
      window.addEventListener('mouseup', onPointerUp);
      scene.addEventListener('touchstart', onPointerDown, { passive: false });
      window.addEventListener('touchend', onPointerUp);
      window.addEventListener('touchcancel', onPointerUp);
    }
    // Also guard: if window loses focus or mouse leaves document, end drag with fling
    window.addEventListener('blur', onPointerUp);
    document.addEventListener('mouseleave', onPointerUp);

    

    // Color sync helpers
    function clampByte(n) { n = parseInt(n||0,10); return isNaN(n)?0: Math.max(0, Math.min(255, n)); }
    function toHex2(n) { const s = clampByte(n).toString(16).padStart(2,'0'); return s; }
    function rgbToHex(r,g,b) { return '#'+toHex2(r)+toHex2(g)+toHex2(b); }
    function hexToRgb(hex) { if (!hex) return null; let h = hex.trim(); if (h[0]==='#') h=h.slice(1); if (h.length!==6) return null; const n = parseInt(h,16); if (isNaN(n)) return null; return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
    function applyColor(r,g,b) {
      const hex = rgbToHex(r,g,b);
      faces.forEach(f => f.style.backgroundColor = hex);
      if (colPreview) colPreview.style.background = hex;
      if (hexInput && hexInput.value.toLowerCase() !== hex) hexInput.value = hex;
      if (rNum) rNum.value = r; if (gNum) gNum.value = g; if (bNum) bNum.value = b;
      if (rRange) rRange.value = r; if (gRange) gRange.value = g; if (bRange) bRange.value = b;
    }
    function initColor() {
      applyColor(255,255,255);
    }
    // Wire events
    if (rRange) rRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (gRange) gRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (bRange) bRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (rNum) rNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (gNum) gNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (bNum) bNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (hexInput) hexInput.addEventListener('input', ()=>{ const c = hexToRgb(hexInput.value); if (c) applyColor(c.r,c.g,c.b); });

    initColor();

    // Placeholder create action: close modal for now
    document.getElementById('nb-create').addEventListener('click', () => {
      // TODO: implement backend create
      modal.style.display = 'none';
      stopAnim();
      resetColorToRandom();
      resetUploads();
    });
  });
  </script>
{% endblock %}
