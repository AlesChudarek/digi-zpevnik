{% extends "dashboard_base.html" %}
{% block title %}Moje zpěvníky{% endblock %}

{% block content %}
{% set upload_limit_mb = max_upload_mb if max_upload_mb is defined and max_upload_mb is not none else 2.0 %}
{% set upload_limit_bytes = max_upload_bytes if max_upload_bytes is defined and max_upload_bytes is not none else 2097152 %}
<style>
  .grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 25px;
    padding: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .songbook-card {
    background: white;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s;
    text-align: center;
    text-decoration: none;
    color: #2E7D32;
    font-weight: bold;
    display: flex;
    flex-direction: column;
    overflow: visible; /* allow tooltips to overflow outside the card */
    position: relative;
    z-index: 1;
  }
  .songbook-card:hover { transform: scale(1.05); }
  .songbook-card:hover,
  .songbook-card:focus-within {
    z-index: 20;
  }

  .cover-preview > img { width: 100%; height: auto; }
  .songbook-card p { margin: 10px; padding: 0; color: var(--brand-strong, #2E7D32); }

  /* Cover preview canvas: fixed ratio 1748x2480 with songbook color background */
  .cover-preview {
    width: 100%;
    aspect-ratio: 1748 / 2480;
    /* Only round top corners to avoid curved bottom edge when image is shorter */
    border-radius: 10px 10px 0 0;
    overflow: visible; /* allow minus icon to stick out */
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
  }
  .cover-preview > img {
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    display: block;
    background: transparent;
    border-radius: 10px 10px 0 0;
  }
  .cover-preview .no-cover {
    color: #ffffff;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.35);
  }

  .shared-indicator {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    background: #ffffff;
    border: 4px solid var(--brand-strong, #2E7D32);
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: default;
    z-index: 2;
  }
  .shared-indicator img { width: 80%; height: 80%; display: block; }
  
  .shared-indicator .shared-tooltip {
    position: absolute;
    top: 46px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: #ffffff;
    font-size: 0.75em;
    padding: 8px 10px;
    border-radius: 6px;
    white-space: normal;
    min-width: 180px;
    text-align: left;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
    z-index: 5000;
  }
  .shared-indicator:hover .shared-tooltip,
  .shared-indicator:focus-within .shared-tooltip {
    opacity: 1;
    pointer-events: auto;
  }
  .shared-tooltip strong {
    display: block;
    margin-bottom: 4px;
  }
  .shared-tooltip ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  .shared-tooltip li {
    line-height: 1.4;
  }
  .shared-tooltip li.owner { font-weight: 600; }
  .shared-tooltip .owner-tag { font-weight: 400; color: rgba(255,255,255,0.7); margin-left: 4px; }

  .songbook-title {
    margin: 10px;
    padding: 0;
    color: var(--brand-strong, #2E7D32);
    overflow: visible;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }

  .songbook-actions {
    display: flex; justify-content: center; gap: 10px; padding: 10px 0 14px;
  }
  .songbook-actions .icon-btn {
    background: white; border: none; border-radius: 50%; width: 36px; height: 36px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.25); cursor: pointer; transition: transform 0.2s;
  }
  .songbook-actions .icon-btn:hover { transform: scale(1.08); }
  .songbook-actions .icon-btn img { width: 20px; height: 20px; display: block; margin: auto; }

  .add-card { cursor: pointer; }
  .add-card .cover {
    width: 100%;
    aspect-ratio: 1748 / 2480; /* match real cover proportions */
    background: #f1f1f1;
    border: 2px dashed #c8c8c8;
    box-sizing: border-box; /* ensure right border isn't clipped by parent overflow */
    display: flex; align-items: center; justify-content: center;
    border-radius: 10px 10px 0 0;
  }
  /* Themed plus icon via CSS mask colored by brand-strong */
  .add-card .plus-icon { width: 72px; height: 72px; background: var(--brand-strong, #2E7D32); }
  .add-card .plus-icon { -webkit-mask: url('{{ static_bust('img/icons/plus_circle.svg') }}') no-repeat center / contain; mask: url('{{ static_bust('img/icons/plus_circle.svg') }}') no-repeat center / contain; }
  .add-card:hover .cover { background: #eaeaea; }
</style>

<!-- Reusable confirm modal -->
<style>
  #app-confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 4000; }
  #app-confirm-overlay .panel { background: var(--muted-bg, #fff); color: var(--brand-dark, #1b5e20); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 16px; width: min(420px, 92vw); }
  #app-confirm-overlay .panel h3 { margin: 0 0 8px; font-size: 18px; }
  #app-confirm-overlay .panel p { margin: 0 0 12px; }
  #app-confirm-overlay .actions { display: flex; justify-content: flex-end; gap: 10px; }
  #app-confirm-overlay .btn { background: white; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #cfe6d3); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  #app-confirm-overlay .btn.primary { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #a7d7b0); }
</style>

<style>
  #share-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 4050; }
  #share-modal .panel { background: var(--muted-bg, #fff); color: var(--brand-dark, #1b5e20); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 18px 20px; width: min(420px, 92vw); display: flex; flex-direction: column; gap: 10px; }
  #share-modal .panel h3 { margin: 0; font-size: 18px; }
  #share-modal label { font-weight: 600; font-size: 14px; }
  #share-modal input[type="email"] { padding: 9px 10px; border-radius: 8px; border: 1px solid var(--muted-border, #dbeadf); font-size: 15px; }
  #share-modal input[type="email"]:focus { outline: 2px solid rgba(46,125,50,0.25); outline-offset: 1px; }
  #share-modal .share-note { margin: 0; font-size: 13px; color: #8a6116; display: flex; align-items: center; gap: 8px; }
  #share-modal .share-note img { width: 18px; height: 18px; }
  #share-modal .feedback { min-height: 20px; font-size: 14px; }
  #share-modal .feedback.error { color: #b00020; }
  #share-modal .feedback.success { color: var(--brand-strong, #2E7D32); }
  #share-modal .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }
</style>

<style>
  #image-resize-notice { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 4075; }
  #image-resize-notice .panel { background: var(--muted-bg, #fff); color: var(--brand-dark, #1b5e20); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 18px 22px; width: min(420px, 92vw); }
  #image-resize-notice h3 { margin: 0 0 8px; font-size: 18px; }
  #image-resize-notice p { margin: 0 0 12px; font-size: 14px; line-height: 1.4; }
  #image-resize-notice label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; user-select: none; }
  #image-resize-notice .actions { display: flex; justify-content: flex-end; margin-top: 14px; }
  #resize-notice-ok { background: #fff !important; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #dbeadf); }
</style>

<div id="app-confirm-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel">
    <h3>Potvrzení</h3>
    <p id="app-confirm-message">Opravdu provést akci?</p>
    <div class="actions">
      <button class="btn" id="app-confirm-cancel">Zrušit</button>
      <button class="btn primary" id="app-confirm-ok">Pokračovat</button>
      <button class="btn" id="app-confirm-save" style="display:none;">Uložit</button>
    </div>
  </div>
  
</div>

<div id="share-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <h3>Sdílet zpěvník</h3>
    <p>Zadej e-mail uživatele, se kterým chceš sdílet <strong id="share-modal-book-title"></strong>.</p>
    <p class="share-note"><img src="{{ static_bust('img/icons/warning.svg') }}" alt="Varování">Uživatel získá právo zpěvník jakkoliv upravovat.</p>
    <label for="share-email-input">E-mail uživatele</label>
    <input type="email" id="share-email-input" placeholder="uzivatel@example.com" autocomplete="email">
    <div id="share-feedback" class="feedback" role="alert" aria-live="polite"></div>
    <div class="actions">
      <button class="btn" id="share-cancel-btn">Zrušit</button>
      <button class="btn primary" id="share-submit-btn">Sdílet</button>
    </div>
  </div>
</div>

<div id="image-resize-notice" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <h3>Velký obrázek</h3>
    <p>Tento obrázek má více než {{ "{:.1f}".format(upload_limit_mb) }}&nbsp;MB. Automaticky ho zmenšíme, aby nezabral zbytečně moc místa.</p>
    <label><input type="checkbox" id="resize-notice-hide"> Příště už nezobrazovat</label>
    <div class="actions">
      <button class="btn primary" id="resize-notice-ok">Pokračovat</button>
    </div>
  </div>
</div>

<h1 style="text-align:center; margin-top: 30px;">Moje zpěvníky</h1>

<div class="grid-container">
  {% for book in songbooks|sort(attribute='id') %}
    <div class="songbook-card">
      <a href="{{ url_for('songbook_detail', book_id=book.id) }}" style="text-decoration:none; color:inherit;">
        <div class="cover-preview" style="background: {{ book.color or '#ffffff' }};">
          {% if book.img_path_cover_preview %}
            <img src="/songbooks/{{ book.img_path_cover_preview }}" alt="Náhled obalu">
          {% else %}
            <div class="no-cover"></div>
          {% endif %}
          {% set share_users = shared_users_map.get(book.id, []) if shared_users_map is defined else [] %}
          {% if share_users %}
            <span class="shared-indicator" tabindex="0">
              <img src="{{ static_bust('img/icons/group.svg') }}" alt="Sdíleno s dalšími uživateli">
              <div class="shared-tooltip" role="tooltip">
                <strong>Sdíleno s:</strong>
                <ul>
                  {% for user in share_users %}
                    <li class="{% if user.is_owner %}owner{% endif %}">{{ user.email }}{% if user.is_owner %}<span class="owner-tag">(vlastník)</span>{% endif %}</li>
                  {% endfor %}
                </ul>
              </div>
            </span>
          {% endif %}
        </div>
        <p style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ book.title }}">{{ book.title }}</p>
      </a>
      <div class="songbook-actions">
        <span class="tooltip" data-tooltip="Upravit zpěvník">
          <button class="icon-btn btn-edit" data-book-id="{{ book.id }}" onclick="event.preventDefault(); event.stopPropagation(); window.openEditSongbookModal && window.openEditSongbookModal('{{ book.id }}');">
            <img src="{{ static_bust('img/icons/edit.svg') }}" alt="Upravit">
          </button>
        </span>
        <span class="tooltip" data-tooltip="Sdílet zpěvník">
          <button class="icon-btn btn-share" data-book-id="{{ book.id }}" data-book-title="{{ book.title|e }}" onclick="event.preventDefault(); event.stopPropagation();">
            <img src="{{ static_bust('img/icons/share.svg') }}" alt="Sdílet">
          </button>
        </span>
        <span class="tooltip" data-tooltip="Smazat zpěvník">
          <button class="icon-btn btn-delete" data-book-id="{{ book.id }}" onclick="event.preventDefault(); event.stopPropagation();">
            <img src="{{ static_bust('img/icons/bin.svg') }}" alt="Smazat">
          </button>
        </span>
      </div>
    </div>
  {% endfor %}

  <!-- Always render an Add card as the last tile -->
  <div class="songbook-card add-card" onclick="/* TODO: add songbook */">
    <div class="cover">
      <div class="plus-icon" aria-hidden="true"></div>
    </div>
    <p>Přidat zpěvník</p>
  </div>
</div>

<!-- Modal: Nová písnička -->
<style>
  #new-song-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 3200; overflow-y: auto; }
  #new-song-modal .modal-wrap { margin-top: 70px; }
  #new-song-modal .modal { background: white; color: var(--brand-dark, #1b5e20); width: min(840px, 94vw); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 20px 22px; }
  #new-song-modal h2 { margin: 0 0 12px; }
  .ns-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 8px 0; }
  .ns-row label { font-weight: 600; font-size: 14px; }
  .ns-row input[type="text"] { padding: 9px 10px; border-radius: 8px; border: 1px solid var(--muted-border, #dbeadf); }
  .ns-ctrl { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
  .ns-ctrl input[type="number"] { width: 80px; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--muted-border, #dbeadf); }
  .ns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px 18px; margin: 10px 0; }
  .ns-file { display: grid; grid-template-columns: 1fr 96px; gap: 8px; align-items: center; }
  /* Reuse dropzone look for consistency with editor */
  .ns-file .dropzone { border: 2px dashed #c8c8c8; border-radius: 10px; padding: 12px; text-align: center; color: #666; background: #fafafa; cursor: pointer; transition: background 0.2s, border-color 0.2s; min-height: 60px; display: flex; align-items: center; justify-content: center; }
  .ns-file .dropzone:hover { background: #f1f1f1; border-color: #a8a8a8; }
  .ns-prev { width: 96px; height: calc(96px * 2480 / 1748); background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  .ns-prev img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; background: #fff; }
  /* Hover preview */
  #ns-hover-preview { position: fixed; pointer-events: none; z-index: 4000; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.35); border: 1px solid #e0e0e0; background: #fff; border-radius: 8px; }
  #ns-hover-preview img { display: block; width: 280px; height: calc(280px * 2480 / 1748); object-fit: contain; background: #fff; }
  .ns-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
  .ns-btn { background: white; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #cfe6d3); padding: 9px 13px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .ns-btn.primary { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #a7d7b0); }
  .ns-btn[disabled] { opacity: 0.5; pointer-events: none; }
</style>

<div id="new-song-modal">
  <div class="modal-wrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="ns-title">
      <h2 id="ns-title">Nová písnička</h2>
      <div class="ns-row">
        <div>
          <label for="ns-title-input">Název</label>
          <input type="text" id="ns-title-input" placeholder="Moje písnička">
        </div>
        <div>
          <label for="ns-author-input">Autor</label>
          <input type="text" id="ns-author-input" placeholder="-">
        </div>
      </div>
      <div class="ns-ctrl">
        <label for="ns-pages">Počet stran písničky</label>
        <input type="number" id="ns-pages" min="1" max="20" value="1">
      </div>
      <div id="ns-files" class="ns-grid"></div>
      <div class="ns-actions">
        <button class="ns-btn" id="ns-cancel">Zrušit</button>
        <div class="btn-with-inline-spinner">
          <span class="btn-spinner" id="ns-save-spinner" aria-hidden="true"></span>
          <button class="ns-btn primary" id="ns-save" disabled>Uložit</button>
        </div>
      </div>
    </div>
  </div>
  
</div>
<div id="ns-hover-preview"><img alt="Náhled"></div>
<!-- Modal: Nový zpěvník (vizuál) -->
<style>
  #new-book-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 3000; overflow-y: auto; }
  #new-book-modal .modal-wrap { margin-top: 70px; }
  body.navbar-hidden #new-book-modal .modal-wrap { margin-top: 20px; }
  #new-book-modal .modal { background: white; color: var(--brand-dark, #1b5e20); width: min(880px, 92vw); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 24px 24px 22px; position: relative; }
  #new-book-modal h2 { margin: 0 0 12px; }
  .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 10px 0 16px; }
  .form-row label { font-weight: 600; font-size: 16px; color: var(--brand-dark, #1b5e20); }
  .form-row input[type="text"] { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--muted-border, #dbeadf); box-shadow: inset 0 1px 2px rgba(0,0,0,0.06); font-size: 14px; background: #fff; color: var(--brand-dark, #1b5e20); }
  .form-row input[type="text"]:focus { outline: 2px solid var(--brand-strong, #1565C0); outline-offset: 1px; border-color: var(--brand-strong, #1565C0); }
  /* cover-enable removed: covers are always enabled */
  .cover-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 20px; overflow: visible; }
  .field-file { display: flex; flex-direction: column; gap: 6px; overflow: visible; }
  .field-file { position: relative; }
  .dropzone {
    border: 2px dashed #c8c8c8;
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    color: #666;
    background: #fafafa;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    width: 100%;
    max-width: 300px;
    min-height: 60px;
    overflow: visible;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
    position: relative;
  }
  .dropzone:hover { background: #f1f1f1; border-color: #a8a8a8; }
  .dropzone.filled { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #dbeadf); color: var(--brand-dark, #1b5e20); }
  .field-file input[type="file"] { display: none; }
  .dz-clear { position: absolute; right: -34px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; display: none; align-items: center; justify-content: center; background: transparent; border: none; padding: 0; cursor: pointer; z-index: 25000; }
  .dz-clear.outside { right: auto; left: 100%; margin-left: 8px; }
  .dz-clear img { width: 22px; height: 22px; opacity: 0.85; pointer-events: none; }
  .dz-clear:hover img { opacity: 1; }
  .dropzone.filled .dz-clear { display: inline-flex; }
  .dz-label {
    font-size: 13px;
    opacity: 0.9;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
    word-break: break-word;
  }
  .disabled-block { opacity: 0.4; pointer-events: none; }
  /* Unify section titles */
  .field-file > label:first-child { font-weight: 600; color: var(--brand-dark, #1b5e20); }

  /* 3D Book preview */
  .book-preview { box-sizing: border-box; margin-top: 12px; display: flex; justify-content: center; align-items: center; background: var(--brand-dark, #0f3a23); padding: 16px 24px; border-radius: 12px; overflow: visible; width: calc(100% - 24px); margin-right: 24px; }
  .book-scene { box-sizing: border-box; }
  .book-scene { --coverW: 120px; --gap: 8px; perspective: 900px; width: calc(var(--coverW) * 2 + var(--gap) + 40px); height: calc(var(--coverW) * 1.42 + 24px); display: flex; align-items: center; justify-content: center; overflow: visible; position: relative; }
  .book-scene { cursor: grab; }
  .book-scene.dragging { cursor: grabbing; }
  .book-scene { touch-action: none; }
  .book-anchor { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); transform-style: preserve-3d; }
  .book { position: relative; transform-style: preserve-3d; transform-origin: 50% 50%; will-change: transform; width: var(--gap); height: calc(var(--coverW) * 1.42); }
  .book-cover { position: absolute; top: 50%; width: var(--coverW); aspect-ratio: 1748 / 2480; border-radius: 8px; transform-style: preserve-3d; }
  /* Hinge each cover to the spine edges so inner edges meet at center */
  .book-cover.right { left: calc(var(--gap) / 2); transform-origin: left center;  transform: translateY(-50%) rotateY(28deg); }
  .book-cover.left  { right: calc(var(--gap) / 2); transform-origin: right center; transform: translateY(-50%) rotateY(-28deg); }
  .book-cover .face { position: absolute; inset: 0; backface-visibility: hidden; background-size: contain; background-repeat: no-repeat; background-position: center; border: 2px solid #ffffff; border-radius: 8px; background-color: #ffffff; }
  .book-cover .face.inner { transform: rotateY(180deg); }
  @keyframes spin-book { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

  /* Layout for book + color controls */
  .book-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; margin-top: 16px; }
  .book-row .book-preview { justify-self: stretch; }
  .book-tools { min-width: 260px; }
  .book-tools label { color: var(--brand-dark, #1b5e20); }
  @media (max-width: 820px) { .book-row { grid-template-columns: 1fr; } .book-tools { width: 100%; } }

  /* Range slider theming: light channel-tinted tracks, black thumbs */
  input[type="range"] { accent-color: #000; }
  /* WebKit */
  #col-r::-webkit-slider-runnable-track { background: #fde8e8; height: 6px; border-radius: 999px; }
  #col-g::-webkit-slider-runnable-track { background: #e8f8ea; height: 6px; border-radius: 999px; }
  #col-b::-webkit-slider-runnable-track { background: #e8eefc; height: 6px; border-radius: 999px; }
  input[type="range"]::-webkit-slider-thumb { background: #111; width: 14px; height: 14px; border-radius: 50%; margin-top: -4px; }
  /* Firefox */
  #col-r::-moz-range-track { background: #fde8e8; height: 6px; border-radius: 999px; }
  #col-g::-moz-range-track { background: #e8f8ea; height: 6px; border-radius: 999px; }
  #col-b::-moz-range-track { background: #e8eefc; height: 6px; border-radius: 999px; }
  input[type="range"]::-moz-range-thumb { background: #111; width: 14px; height: 14px; border: none; border-radius: 50%; }
  /* MS Edge legacy */
  #col-r::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-g::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-b::-ms-track { background: transparent; border-color: transparent; color: transparent; }
  #col-r::-ms-fill-lower, #col-r::-ms-fill-upper { background: #fde8e8; }
  #col-g::-ms-fill-lower, #col-g::-ms-fill-upper { background: #e8f8ea; }
  #col-b::-ms-fill-lower, #col-b::-ms-fill-upper { background: #e8eefc; }
  input[type="range"]::-ms-thumb { background: #111; border: none; }

  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
  .btn { background: white; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #cfe6d3); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #a7d7b0); }
  .btn[disabled] { opacity: 0.55; cursor: not-allowed; pointer-events: none; }
  .btn-spinner { width: 20px; height: 20px; border-radius: 50%; border: 3px solid rgba(27,94,32,0.25); border-top-color: var(--brand-strong, #2E7D32); animation: btn-spin 0.8s linear infinite; display: inline-block; visibility: hidden; opacity: 0; transition: opacity 0.2s ease; flex-shrink: 0; }
  .btn-spinner.active { visibility: visible; opacity: 1; }
  .btn-with-inline-spinner { display: flex; align-items: center; gap: 8px; }
  @keyframes btn-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .btn-top-save-wrap { position: absolute; right: 24px; top: 12px; display: flex; align-items: center; gap: 10px; z-index: 10; }
  .btn-top-save { padding: 20px 34px; font-size: 18px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); min-height: 56px; min-width: 160px; }
  .section-title { margin: 18px 0 8px; font-size: 16px; color: var(--brand-dark, #1b5e20); }
  /* Hide bottom actions in create/edit modal; closing is via click outside */
  #new-book-modal .modal .modal-actions { display: none; }
  .btn:hover { filter: brightness(0.98); }
</style>

<div id="new-book-modal">
  <div class="modal-wrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nb-title">
      <h2 id="nb-title">Nový zpěvník</h2>
      <div class="btn-top-save-wrap">
        <span class="btn-spinner" id="nb-save-top-spinner" aria-hidden="true"></span>
        <button class="btn primary btn-top-save" id="nb-save-top">Uložit</button>
      </div>
      <!-- Hidden removal flags for re-use edit mode in this modal -->
      <input type="hidden" id="erem-front_outer" value="0">
      <input type="hidden" id="erem-front_inner" value="0">
      <input type="hidden" id="erem-back_inner" value="0">
      <input type="hidden" id="erem-back_outer" value="0">
      <div class="form-row">
        <label for="nb-name">Název zpěvníku</label>
        <input type="text" id="nb-name" placeholder="např. Můj nový zpěvník">
      </div>

      <!-- Cover toggle removed: covers are always enabled -->

      <div id="cover-config">
        <div class="cover-grid">
          <div class="field-file">
            <label>Přední obálka zvenku</label>
          <label class="dropzone" id="dz-front-outer">
            <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="file-front-outer">
            <button class="dz-clear" id="clear-front-outer" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Zadní obálka zvenku</label>
          <label class="dropzone" id="dz-back-outer">
            <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="file-back-outer">
            <button class="dz-clear" id="clear-back-outer" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Přední obálka zevnitř</label>
          <label class="dropzone" id="dz-front-inner">
            <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="file-front-inner">
            <button class="dz-clear" id="clear-front-inner" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Zadní obálka zevnitř</label>
          <label class="dropzone" id="dz-back-inner">
            <span class="dz-label">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="file-back-inner">
            <button class="dz-clear" id="clear-back-inner" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        </div>

        <div class="book-row">
          <div class="book-preview" id="book-preview">
            <div class="book-scene">
              <div class="book-anchor">
                <div class="book" id="book-3d">
                  <div class="book-cover left">
                    <div class="face outer" id="tex-back-outer"></div>
                    <div class="face inner" id="tex-back-inner"></div>
                  </div>
                  <div class="book-cover right">
                    <div class="face outer" id="tex-front-outer"></div>
                    <div class="face inner" id="tex-front-inner"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="book-tools" id="cover-color-tools" style="display:flex; flex-direction:column; gap:10px;">
            <label style="font-weight:600; font-size:14px;">Barva obálky</label>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">R</span>
              <input type="range" id="col-r" min="0" max="255" value="255">
              <input type="number" id="num-r" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">G</span>
              <input type="range" id="col-g" min="0" max="255" value="255">
              <input type="number" id="num-g" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="rgb-row" style="display:grid; grid-template-columns: 34px 180px 60px; gap:8px; align-items:center;">
              <span style="font-size:12px;">B</span>
              <input type="range" id="col-b" min="0" max="255" value="255">
              <input type="number" id="num-b" min="0" max="255" value="255" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
            </div>
            <div class="hex-row" style="display:grid; grid-template-columns: max-content 140px max-content; gap:8px; align-items:center;">
              <span style="font-size:12px;">HEX</span>
              <input type="text" id="hex-col" value="#ffffff" maxlength="7" style="padding:6px 8px; border-radius:8px; border:1px solid #cfe6d3;">
              <div id="col-preview" style="width:28px; height:28px; border-radius:6px; border:1px solid #cfe6d3; background:#ffffff;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="nb-cancel" style="display:none;">Zrušit</button>
        <button class="btn primary" id="nb-create" style="display:none;">Uložit</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Edit songbook -->
<style>
  #edit-book-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 3000; overflow-y: auto; }
  #edit-book-modal .modal-wrap { margin-top: 70px; }
  #edit-book-modal .modal { background: white; color: var(--brand-dark, #1b5e20); width: min(980px, 94vw); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); padding: 24px 24px 22px; }
  #edit-book-modal .modal { position: relative; }
  #edit-book-modal h2 { margin: 0 0 12px; }
  .edit-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
  .songs-list { border: 1px solid var(--muted-border, #dbeadf); border-radius: 10px; overflow: visible; }
  .songs-list table { width: 100%; border-collapse: collapse; }
  .songs-list th, .songs-list td { padding: 10px 12px; border-top: 1px solid var(--muted-border, #e2e8f0); text-align: left; }
  .songs-list tr:first-child th { border-top: none; }
  .drag-handle { cursor: grab; user-select: none; font-size: 18px; opacity: 0.7; }
  .songs-list tr.dragging { opacity: 0.6; }
  .row-action { background: none; border: none; padding: 0; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
  .row-action img { width: 22px; height: 22px; display: block; filter: invert(27%) sepia(81%) saturate(4041%) hue-rotate(342deg) brightness(102%) contrast(97%); transition: transform 0.12s ease-in-out; }
  .row-action:hover img { transform: scale(1.08); }
  .songs-list .page-span { text-align: center; }
  .songs-list th.center, .songs-list td.center { text-align: center; }
  .songs-list th.action-col, .songs-list td.action-cell { text-align: center; }
  #eb-songs tr[data-new-song="1"] td { font-style: italic; }
  .pending-pill { display: inline-flex; align-items: center; gap: 4px; background: #fff3cd; color: #8a6116; font-size: 12px; padding: 2px 6px; border-radius: 999px; margin-left: 6px; vertical-align: middle; }
  .songs-toolbar { display: flex; align-items: center; gap: 16px; }
  .songs-toolbar label { display: flex; align-items: center; gap: 8px; }
  .page-input { width: 64px; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--muted-border, #dbeadf); }
  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
  .btn { background: white; color: var(--brand-dark, #1b5e20); border: 1px solid var(--muted-border, #cfe6d3); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--muted-bg, #e8f5e9); border-color: var(--muted-border, #a7d7b0); }
  /* Hide bottom actions in classic edit modal too */
  #edit-book-modal .modal .modal-actions { display: none; }
</style>

<div id="edit-book-modal">
  <div class="modal-wrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="eb-title">
      <h2 id="eb-title">Upravit zpěvník</h2>
      <div class="btn-top-save-wrap">
        <span class="btn-spinner" id="eb-save-top-spinner" aria-hidden="true"></span>
        <button class="btn primary btn-top-save" id="eb-save-top">Uložit</button>
      </div>
      <!-- Hidden removal flags for edit modal -->
      <input type="hidden" id="erem-front_outer" value="0">
      <input type="hidden" id="erem-front_inner" value="0">
      <input type="hidden" id="erem-back_inner" value="0">
      <input type="hidden" id="erem-back_outer" value="0">
      <div class="form-row">
        <label for="eb-name">Název zpěvníku</label>
        <input type="text" id="eb-name" placeholder="Název">
      </div>
      <div class="form-row">
        <label for="eb-color">Barva obálky (HEX)</label>
        <input type="text" id="eb-color" class="page-input" value="#ffffff">
      </div>

      <div class="cover-grid" style="margin-top:4px;">
        <div class="field-file">
          <label>Přední obálka zvenku</label>
          <label class="dropzone" id="edz-front-outer">
            <span class="dz-label" id="elab-front-outer">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="efile-front-outer">
            <button class="dz-clear" id="eclear-front-outer" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Zadní obálka zvenku</label>
          <label class="dropzone" id="edz-back-outer">
            <span class="dz-label" id="elab-back-outer">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="efile-back-outer">
            <button class="dz-clear" id="eclear-back-outer" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Přední obálka zevnitř</label>
          <label class="dropzone" id="edz-front-inner">
            <span class="dz-label" id="elab-front-inner">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="efile-front-inner">
            <button class="dz-clear" id="eclear-front-inner" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
        <div class="field-file">
          <label>Zadní obálka zevnitř</label>
          <label class="dropzone" id="edz-back-inner">
            <span class="dz-label" id="elab-back-inner">Klikni nebo přetáhni obrázek sem</span>
            <input type="file" accept="image/*" id="efile-back-inner">
            <button class="dz-clear" id="eclear-back-inner" title="Odebrat"><img src="{{ static_bust('img/icons/minus_circle.svg') }}" alt="Odebrat"></button>
          </label>
        </div>
      </div>

      <div class="book-row">
        <div class="book-preview" id="ebook-preview">
          <div class="book-scene">
            <div class="book-anchor">
              <div class="book" id="ebook-3d">
                <div class="book-cover left">
                  <div class="face outer" id="etex-back-outer"></div>
                  <div class="face inner" id="etex-back-inner"></div>
                </div>
                <div class="book-cover right">
                  <div class="face outer" id="etex-front-outer"></div>
                  <div class="face inner" id="etex-front-inner"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="book-tools"></div>
      </div>
      <div class="section-head" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 6px;">
        <h3 class="section-title" style="margin: 0;">Písničky</h3>
        <div class="right-actions" style="display:flex; align-items:center; gap:8px;">
          <button class="btn" id="btn-add-blank-page-eb">Přidat prázdnou stránku</button>
          <button class="btn primary" id="btn-add-custom-song-eb">Přidat svou písničku</button>
        </div>
      </div>
      <div class="songs-toolbar" style="margin-top:6px;">
        <label><input type="checkbox" id="eb-auto" checked> Automatické číslování</label>
      </div>
      <div class="songs-list" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th style="width:36px;">&nbsp;</th>
              <th>Název</th>
              <th>Autor</th>
              <th class="center" style="width:120px;">První strana</th>
              <th style="width:90px;">Stran</th>
              <th class="action-col" style="width:80px; text-align:center;">Odebrat</th>
            </tr>
          </thead>
          <tbody id="eb-songs"></tbody>
        </table>
      </div>

      <div class="modal-actions">
        <button class="btn" id="eb-cancel" style="display:none;">Zavřít</button>
        <button class="btn primary" id="eb-save" style="display:none;">Uložit</button>
      </div>
    </div>
  </div>
</div>

  <script>
    // Global confirm dialog helper (theme-aware)
    window.showConfirm = function(message, okText) {
      return new Promise((resolve) => {
        const overlay = document.getElementById('app-confirm-overlay');
        const msgEl = document.getElementById('app-confirm-message');
        const btnOk = document.getElementById('app-confirm-ok');
        const btnCancel = document.getElementById('app-confirm-cancel');
        const btnSave = document.getElementById('app-confirm-save');
        if (!overlay || !msgEl || !btnOk || !btnCancel) {
          // Fallback to native confirm if custom markup is missing
          // eslint-disable-next-line no-alert
          return resolve(window.confirm(message || 'Potvrdit akci?'));
        }
        msgEl.textContent = message || 'Potvrdit akci?';
        if (btnOk) btnOk.textContent = okText || 'Pokračovat';
        // Generic confirm: ensure save is hidden and make Cancel primary (swap colors)
        if (btnSave) btnSave.style.display = 'none';
        btnOk.classList.remove('primary');
        btnCancel.classList.add('primary');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');

        const cleanup = () => {
          overlay.style.display = 'none';
          overlay.setAttribute('aria-hidden', 'true');
          btnOk.removeEventListener('click', onOk);
          btnCancel.removeEventListener('click', onCancel);
          overlay.removeEventListener('click', onOverlay);
          document.removeEventListener('keydown', onKey);
        };
        const onOk = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };
        const onOverlay = (e) => { if (e.target === overlay) onCancel(); };
        const onKey = (e) => { if (e.key === 'Escape') onCancel(); if (e.key === 'Enter') onOk(); };
        btnOk.addEventListener('click', onOk);
        btnCancel.addEventListener('click', onCancel);
        overlay.addEventListener('click', onOverlay);
        document.addEventListener('keydown', onKey);
      });
    };
    // Three-option confirm for unsaved changes (Cancel/Discard/Save)
    window.showUnsavedConfirm = function(message) {
      return new Promise((resolve) => {
        const overlay = document.getElementById('app-confirm-overlay');
        const msgEl = document.getElementById('app-confirm-message');
        const btnOk = document.getElementById('app-confirm-ok');
        const btnCancel = document.getElementById('app-confirm-cancel');
        const btnSave = document.getElementById('app-confirm-save');
        if (!overlay || !msgEl || !btnOk || !btnCancel || !btnSave) {
          // Fallback: native confirm with Discard/Cancel semantics
          // eslint-disable-next-line no-alert
          const ok = window.confirm(message || 'Zahodit neuložené změny?');
          return resolve(ok ? 'discard' : 'cancel');
        }
        msgEl.textContent = message || 'Zahodit neuložené změny?';
        btnOk.textContent = 'Zahodit';
        btnSave.textContent = 'Uložit';
        // Show Save; make Cancel and Discard primary (colored), Save white
        btnSave.style.display = '';
        btnSave.classList.remove('primary');
        btnCancel.classList.add('primary');
        btnOk.classList.add('primary');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');

        const cleanup = () => {
          overlay.style.display = 'none';
          overlay.setAttribute('aria-hidden', 'true');
          btnOk.removeEventListener('click', onDiscard);
          btnCancel.removeEventListener('click', onCancel);
          btnSave.removeEventListener('click', onSave);
          overlay.removeEventListener('click', onOverlay);
          document.removeEventListener('keydown', onKey);
          // Hide save and clear button primary states; next dialog sets them explicitly
          btnSave.style.display = 'none';
          btnSave.classList.remove('primary');
          btnOk.classList.remove('primary');
          btnCancel.classList.remove('primary');
        };
        const onDiscard = () => { cleanup(); resolve('discard'); };
        const onCancel = () => { cleanup(); resolve('cancel'); };
        const onSave = () => { cleanup(); resolve('save'); };
        const onOverlay = (e) => { if (e.target === overlay) onCancel(); };
        const onKey = (e) => { if (e.key === 'Escape') onCancel(); if (e.key === 'Enter') onSave(); };
        btnOk.addEventListener('click', onDiscard);
        btnCancel.addEventListener('click', onCancel);
        btnSave.addEventListener('click', onSave);
        overlay.addEventListener('click', onOverlay);
        document.addEventListener('keydown', onKey);
      });
    };

    const IMAGE_SIZE_LIMIT_BYTES = {{ upload_limit_bytes|int }};
    const RESIZE_NOTICE_STORAGE_KEY = 'dz_hide_resize_notice';
    const resizeNoticeOverlay = document.getElementById('image-resize-notice');
    const resizeNoticeOk = document.getElementById('resize-notice-ok');
    const resizeNoticeCheckbox = document.getElementById('resize-notice-hide');
    let resizeNoticeOpen = false;

    function isResizeNoticeSuppressed() {
      try {
        return window.localStorage.getItem(RESIZE_NOTICE_STORAGE_KEY) === '1';
      } catch (_) {
        return false;
      }
    }

    function setResizeNoticeSuppressed(flag) {
      try {
        if (flag) {
          window.localStorage.setItem(RESIZE_NOTICE_STORAGE_KEY, '1');
        } else {
          window.localStorage.removeItem(RESIZE_NOTICE_STORAGE_KEY);
        }
      } catch (_) {}
    }

    function closeResizeNotice() {
      if (!resizeNoticeOverlay) return;
      resizeNoticeOverlay.style.display = 'none';
      resizeNoticeOverlay.setAttribute('aria-hidden', 'true');
      resizeNoticeOpen = false;
      if (resizeNoticeCheckbox) {
        if (resizeNoticeCheckbox.checked) {
          setResizeNoticeSuppressed(true);
        } else {
          setResizeNoticeSuppressed(false);
        }
        resizeNoticeCheckbox.checked = false;
      }
    }

    function maybeShowResizeNotice() {
      if (!resizeNoticeOverlay || !IMAGE_SIZE_LIMIT_BYTES) return;
      if (resizeNoticeOpen || isResizeNoticeSuppressed()) return;
      resizeNoticeOpen = true;
      resizeNoticeOverlay.style.display = 'flex';
      resizeNoticeOverlay.setAttribute('aria-hidden', 'false');
      if (resizeNoticeCheckbox) resizeNoticeCheckbox.checked = false;
    }

    if (resizeNoticeOk) {
      resizeNoticeOk.addEventListener('click', (event) => {
        event.preventDefault();
        closeResizeNotice();
      });
    }
    if (resizeNoticeOverlay) {
      resizeNoticeOverlay.addEventListener('click', (event) => {
        if (event.target === resizeNoticeOverlay) {
          closeResizeNotice();
        }
      });
    }
    document.addEventListener('keydown', (event) => {
      if (resizeNoticeOpen && event.key === 'Escape') {
        closeResizeNotice();
      }
    });

    function notifyIfLargeFile(file) {
      if (!file || typeof file.size !== 'number' || !IMAGE_SIZE_LIMIT_BYTES) return;
      if (file.size > IMAGE_SIZE_LIMIT_BYTES) {
        maybeShowResizeNotice();
      }
    }

    function toggleButtonLoading(button, spinner, isLoading, loadingLabel) {
      if (!button) return false;
      if (isLoading) {
        if (button.dataset.loading === '1') return false;
        button.dataset.loading = '1';
        button.dataset.prevLabel = button.textContent;
        if (loadingLabel) {
          button.textContent = loadingLabel;
        }
        button.disabled = true;
        if (spinner) spinner.classList.add('active');
        return true;
      }
      button.dataset.loading = '0';
      if (button.dataset.prevLabel !== undefined) {
        button.textContent = button.dataset.prevLabel;
        delete button.dataset.prevLabel;
      }
      button.disabled = false;
      if (spinner) spinner.classList.remove('active');
      return true;
    }
    // Open modal from the add-card
    document.addEventListener('DOMContentLoaded', () => {
      const addCard = document.querySelector('.add-card');
      const modal = document.getElementById('new-book-modal');
      const coverConfig = document.getElementById('cover-config');
      const scene = document.querySelector('.book-scene');
      const book = document.getElementById('book-3d');
      const colorTools = document.getElementById('cover-color-tools');
      const modalContent = document.querySelector('#new-book-modal .modal');
      const shareModal = document.getElementById('share-modal');
      const shareEmailInput = document.getElementById('share-email-input');
      const shareTitleEl = document.getElementById('share-modal-book-title');
      const shareFeedback = document.getElementById('share-feedback');
      const shareSubmitBtn = document.getElementById('share-submit-btn');
      const shareCancelBtn = document.getElementById('share-cancel-btn');
      const nbCreateBtn = document.getElementById('nb-create');
      const nbSaveTopBtn = document.getElementById('nb-save-top');
      const nbSaveTopSpinner = document.getElementById('nb-save-top-spinner');
      const nsSaveBtn = document.getElementById('ns-save');
      const nsSaveSpinner = document.getElementById('ns-save-spinner');

      let rafId = null;
      const DURATION_MS = 8000; // default full turn time
      const DEFAULT_SPEED = -360 / (DURATION_MS / 1000); // deg per second (author's default)
      const DEFAULT_MAG = Math.abs(DEFAULT_SPEED);
      let currentAngle = 0; // degrees
      let currentSpeed = DEFAULT_SPEED; // deg/s
      let lastTs = null;
      let easing = false;
      let easeStartTs = 0;
      const EASE_MS = 800; // ramp back to default speed after hold
      let easeFromSpeed = 0;
      let easeTargetSpeed = DEFAULT_SPEED;
      let holdTimeout = null;
      let dragging = false;
      let lastX = 0;
      let lastMoveTs = 0;
      let lastVelocity = 0; // deg/s estimated during drag
      let justDragged = false;
      let justDraggedTimer = null;

      function animate(ts) {
        if (!lastTs) lastTs = ts;
        const dt = (ts - lastTs) / 1000; // seconds
        lastTs = ts;

        // Ease back to default speed after user interaction
        if (easing) {
          const t = Math.min(1, (ts - easeStartTs) / EASE_MS);
          currentSpeed = easeFromSpeed + (easeTargetSpeed - easeFromSpeed) * t; // smooth to target with preserved sign
          if (t >= 1) easing = false;
        }

        // Integrate angle
        currentAngle += currentSpeed * dt;
        book.style.transform = `rotateY(${currentAngle}deg)`;
        rafId = requestAnimationFrame(animate);
      }

      function startAnim() {
        if (!rafId) {
          lastTs = null;
          currentSpeed = DEFAULT_SPEED;
          rafId = requestAnimationFrame(animate);
        }
      }

      function stopAnim() {
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
      }

      function resetColorToRandom() {
        const r = Math.floor(Math.random()*256), g = Math.floor(Math.random()*256), b = Math.floor(Math.random()*256);
        applyColor(r,g,b);
      }

      function resetUploads() {
        const pairs = [
          { dz: 'dz-front-outer', file: 'file-front-outer', face: 'tex-front-outer' },
          { dz: 'dz-back-outer',  file: 'file-back-outer',  face: 'tex-back-outer'  },
          { dz: 'dz-front-inner', file: 'file-front-inner', face: 'tex-front-inner' },
          { dz: 'dz-back-inner',  file: 'file-back-inner',  face: 'tex-back-inner'  },
        ];
        const defaultText = 'Klikni nebo přetáhni obrázek sem';
        pairs.forEach(p => {
          const dz = document.getElementById(p.dz);
          const input = document.getElementById(p.file);
          const face = document.getElementById(p.face);
          if (input) { input.value = ''; }
          if (face) { face.style.backgroundImage = ''; }
          if (dz) {
            dz.classList.remove('filled');
            const lab = dz.querySelector('.dz-label');
            if (lab) { lab.textContent = defaultText; lab.style.fontWeight = '600'; }
          }
        });
      }

let createDirty = false;
function openCreateModal() {
  // If an edit-injected section from a previous session exists, remove it
  try { const editSection = document.getElementById('edit-songs-section'); if (editSection) editSection.remove(); } catch(_) {}
  // Reset dirty flag for fresh create session
  createDirty = false;
  // Reset heading/primary only when NOT in edit mode
  if (!window.__editMode) {
    const titleEl = document.getElementById('nb-title'); if (titleEl) titleEl.textContent = 'Nový zpěvník';
    const primaryBtn = document.getElementById('nb-create'); if (primaryBtn) primaryBtn.textContent = 'Vytvořit';
    const nameInput = document.getElementById('nb-name'); if (nameInput) nameInput.value = '';
      // Cover toggle removed
  }
  modal.style.display = 'flex'; startAnim(); resetColorToRandom(); resetUploads(); justDragged = false; pointerDownOnOverlay = false; startedInsideContent = false;
}

      if (addCard) addCard.addEventListener('click', () => {
        // Explicitly enter create mode
        window.__editMode = false; window.__editBookId = null;
        openCreateModal();
      });
      // Auto-open when ?create=1 is present
      try {
        const sp = new URLSearchParams(window.location.search);
        if (sp.get('create') === '1') { window.__editMode = false; window.__editBookId = null; openCreateModal(); }
      } catch(_) {}
      document.getElementById('nb-cancel').addEventListener('click', async (e) => {
        const changed = window.__editMode ? hasEditModeChanges() : !!createDirty;
        if (changed) {
          const choice = await window.showUnsavedConfirm('Zahodit neuložené změny?');
          if (choice === 'cancel') { e.preventDefault(); return; }
          if (choice === 'save') { nbCreateBtn?.click(); return; }
        }
        modal.style.display = 'none'; stopAnim(); resetColorToRandom(); resetUploads();
        // Leaving create/edit modal: ensure next open via "+" is fresh create
        window.__editMode = false; window.__editBookId = null; window.__editInitialState = null;
        window.__pendingNewSongs = new Map();
        try { if (window.__pendingSongDeletes && typeof window.__pendingSongDeletes.clear === 'function') { window.__pendingSongDeletes.clear(); } } catch(_) {}
      });
      // Close only if the click started on overlay and ended on overlay (no drag from content)
      let pointerDownOnOverlay = false;
      let startedInsideContent = false;
      modal.addEventListener('mousedown', (e) => { pointerDownOnOverlay = (e.target === modal); startedInsideContent = false; });
      modal.addEventListener('touchstart', (e) => { pointerDownOnOverlay = (e.target === modal); startedInsideContent = false; }, { passive: true });
      if (modalContent) {
        modalContent.addEventListener('mousedown', () => { startedInsideContent = true; pointerDownOnOverlay = false; });
        modalContent.addEventListener('touchstart', () => { startedInsideContent = true; pointerDownOnOverlay = false; }, { passive: true });
      }
      modal.addEventListener('click', async (e) => {
        const shouldClose = (e.target === modal) && pointerDownOnOverlay && !dragging && !justDragged && !startedInsideContent;
        if (shouldClose) {
          const changed = window.__editMode ? hasEditModeChanges() : !!createDirty;
          if (changed) {
            const choice = await window.showUnsavedConfirm('Zahodit neuložené změny?');
            if (choice === 'cancel') { pointerDownOnOverlay = false; startedInsideContent = false; return; }
            if (choice === 'save') { nbCreateBtn?.click(); return; }
          }
          modal.style.display = 'none';
          stopAnim();
          resetColorToRandom();
          resetUploads();
          window.__editMode = false; window.__editBookId = null; window.__editInitialState = null;
          window.__pendingNewSongs = new Map();
          try { if (window.__pendingSongDeletes && typeof window.__pendingSongDeletes.clear === 'function') { window.__pendingSongDeletes.clear(); } } catch(_) {}
        }
        // reset flags after any click
        pointerDownOnOverlay = false;
        startedInsideContent = false;
      });

    // Color controls refs (declared before setCoverEnabled so it can use them)
    const faces = Array.from(document.querySelectorAll('.book-cover .face'));
    const rRange = document.getElementById('col-r');
    const gRange = document.getElementById('col-g');
    const bRange = document.getElementById('col-b');
    const rNum = document.getElementById('num-r');
    const gNum = document.getElementById('num-g');
    const bNum = document.getElementById('num-b');
    const hexInput = document.getElementById('hex-col');
    const colPreview = document.getElementById('col-preview');

    function setCoverEnabled(enabled) {
      coverConfig.classList.toggle('disabled-block', false);
      coverConfig.querySelectorAll('input[type="file"]').forEach(inp => inp.disabled = false);
      if (colorTools) colorTools.classList.toggle('disabled-block', false);
      [rRange,gRange,bRange,rNum,gNum,bNum,hexInput].forEach(el => { if (el) el.disabled = false; });
    }
    setCoverEnabled(true);

    // Helpers to wire up dropzones and previews
    function bindFile(idInput, idDz, idTargetFace) {
      const input = document.getElementById(idInput);
      const dz = document.getElementById(idDz);
      const face = document.getElementById(idTargetFace);
      const label = dz.querySelector('.dz-label');

      function handleFiles(files) {
        if (!files || !files[0]) return;
        const file = files[0];
        notifyIfLargeFile(file);
        const url = URL.createObjectURL(file);
        if (face) face.style.backgroundImage = `url('${url}')`;
        if (label) { label.textContent = file.name; label.style.fontWeight = '700'; }
        dz.classList.add('filled');
      }

      dz.addEventListener('click', () => input.click());
      input.addEventListener('change', (e) => handleFiles(e.target.files));
      ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.add('hover'); }));
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.remove('hover'); }));
      dz.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files && files.length) {
          input.files = files; // reflect into input
          handleFiles(files);
        }
      });

      // Clear button next to dropzone
      const clearBtnId = idInput.replace('file-', 'clear-');
      const clearBtn = document.getElementById(clearBtnId);
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.preventDefault(); e.stopPropagation();
          if (input) input.value = '';
          if (face) face.style.backgroundImage = '';
          if (dz) dz.classList.remove('filled');
          if (label) { label.textContent = 'Klikni nebo přetáhni obrázek sem'; label.style.fontWeight = '600'; }
          // Set removal flag and mark dirty for change detection
          try {
            const key = idInput.replace('file-', '').replace(/-/g, '_'); // e.g. front_outer
            const rem = document.getElementById('erem-' + key);
            if (rem) { rem.value = '1'; }
            createDirty = true;
          } catch(_) {}
        });
      }
    }

    bindFile('file-front-outer', 'dz-front-outer', 'tex-front-outer');
    bindFile('file-back-outer', 'dz-back-outer', 'tex-back-outer');
    bindFile('file-front-inner', 'dz-front-inner', 'tex-front-inner');
    bindFile('file-back-inner', 'dz-back-inner', 'tex-back-inner');

    // Mark create modal as dirty on changes
    try {
      const nbName = document.getElementById('nb-name'); if (nbName) nbName.addEventListener('input', () => { createDirty = true; });
      // cover toggle removed
      if (hexInput) hexInput.addEventListener('input', () => { createDirty = true; });
      const fileIds = ['file-front-outer','file-back-outer','file-front-inner','file-back-inner'];
      fileIds.forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', () => { createDirty = true; }); });
      if (rRange) rRange.addEventListener('input', () => { createDirty = true; });
      if (gRange) gRange.addEventListener('input', () => { createDirty = true; });
      if (bRange) bRange.addEventListener('input', () => { createDirty = true; });
      if (rNum) rNum.addEventListener('input', () => { createDirty = true; });
      if (gNum) gNum.addEventListener('input', () => { createDirty = true; });
      if (bNum) bNum.addEventListener('input', () => { createDirty = true; });
    } catch(_) {}

    // Drag-to-rotate with inertia
    function onPointerDown(e) {
      dragging = true;
      lastX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
      lastMoveTs = performance.now();
      lastVelocity = 0;
      currentSpeed = 0; // pause auto-rotation during drag
      scene.classList.add('dragging');
      document.body.style.userSelect = 'none';
      // Listen globally so drag can continue outside
      window.addEventListener('mousemove', onPointerMove);
      window.addEventListener('touchmove', onPointerMove, { passive: false });
      e.preventDefault();
    }

    function onPointerMove(e) {
      if (!dragging) return;
      const now = performance.now();
      const x = e.clientX || (e.touches && e.touches[0]?.clientX) || lastX;
      const dx = x - lastX;
      lastX = x;
      const dt = Math.max(0.001, (now - lastMoveTs) / 1000);
      lastMoveTs = now;
      const SENS = 0.45; // deg per pixel
      currentAngle += dx * SENS;
      book.style.transform = `rotateY(${currentAngle}deg)`;
      // estimate velocity in deg/s, clamp
      const v = (dx * SENS) / dt;
      const MAX_V = 720;
      lastVelocity = Math.max(-MAX_V, Math.min(MAX_V, v));
      e.preventDefault();
    }

    function onPointerUp() {
      if (!dragging) return;
      dragging = false;
      scene.classList.remove('dragging');
      document.body.style.userSelect = '';
      window.removeEventListener('mousemove', onPointerMove);
      window.removeEventListener('touchmove', onPointerMove);
      // Fling with last velocity for 1s, then ease back
      currentSpeed = lastVelocity;
      if (holdTimeout) clearTimeout(holdTimeout);
      holdTimeout = setTimeout(() => {
        easing = true;
        easeStartTs = performance.now();
        easeFromSpeed = currentSpeed;
        // Set target speed to default magnitude but preserve user's last direction
        const dir = (easeFromSpeed === 0) ? Math.sign(DEFAULT_SPEED) || 1 : Math.sign(easeFromSpeed);
        easeTargetSpeed = dir * DEFAULT_MAG;
      }, 1000);
      // Prevent overlay click close immediately after drag end
      justDragged = true;
      if (justDraggedTimer) clearTimeout(justDraggedTimer);
      justDraggedTimer = setTimeout(() => { justDragged = false; }, 300);
    }

    // Prefer Pointer Events with capture; fallback to mouse/touch
    if (window.PointerEvent) {
      scene.addEventListener('pointerdown', (e) => { onPointerDown(e); try { scene.setPointerCapture(e.pointerId); } catch(_){} });
      scene.addEventListener('pointermove', onPointerMove);
      scene.addEventListener('pointerup', onPointerUp);
      scene.addEventListener('pointercancel', onPointerUp);
    } else {
      scene.addEventListener('mousedown', onPointerDown);
      window.addEventListener('mouseup', onPointerUp);
      scene.addEventListener('touchstart', onPointerDown, { passive: false });
      window.addEventListener('touchend', onPointerUp);
      window.addEventListener('touchcancel', onPointerUp);
    }
    // Also guard: if window loses focus or mouse leaves document, end drag with fling
    window.addEventListener('blur', onPointerUp);
    document.addEventListener('mouseleave', onPointerUp);

    

    // Color sync helpers
    function clampByte(n) { n = parseInt(n||0,10); return isNaN(n)?0: Math.max(0, Math.min(255, n)); }
    function toHex2(n) { const s = clampByte(n).toString(16).padStart(2,'0'); return s; }
    function rgbToHex(r,g,b) { return '#'+toHex2(r)+toHex2(g)+toHex2(b); }
    function hexToRgb(hex) { if (!hex) return null; let h = hex.trim(); if (h[0]==='#') h=h.slice(1); if (h.length!==6) return null; const n = parseInt(h,16); if (isNaN(n)) return null; return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
    function applyColor(r,g,b) {
      const hex = rgbToHex(r,g,b);
      faces.forEach(f => f.style.backgroundColor = hex);
      if (colPreview) colPreview.style.background = hex;
      if (hexInput && hexInput.value.toLowerCase() !== hex) hexInput.value = hex;
      if (rNum) rNum.value = r; if (gNum) gNum.value = g; if (bNum) bNum.value = b;
      if (rRange) rRange.value = r; if (gRange) gRange.value = g; if (bRange) bRange.value = b;
    }
    function initColor() {
      applyColor(255,255,255);
    }
    // Wire events
    if (rRange) rRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (gRange) gRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (bRange) bRange.addEventListener('input', ()=>applyColor(+rRange.value, +gRange.value, +bRange.value));
    if (rNum) rNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (gNum) gNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (bNum) bNum.addEventListener('input', ()=>{ applyColor(clampByte(rNum.value), clampByte(gNum.value), clampByte(bNum.value)); });
    if (hexInput) hexInput.addEventListener('input', ()=>{ const c = hexToRgb(hexInput.value); if (c) applyColor(c.r,c.g,c.b); });

    initColor();

    // Create private songbook
    if (nbCreateBtn) {
      nbCreateBtn.addEventListener('click', async () => {
        if (window.__editMode) return;
        if (nbCreateBtn.dataset.loading === '1') return;
        toggleButtonLoading(nbCreateBtn, null, true, 'Ukládám…');
        toggleButtonLoading(nbSaveTopBtn, nbSaveTopSpinner, true, 'Ukládám…');
        const nameEl = document.getElementById('nb-name');
        // cover toggle removed (always enabled)
        const hexInput = document.getElementById('hex-col');
        const files = {
          front_outer: document.getElementById('file-front-outer')?.files?.[0] || null,
          back_outer: document.getElementById('file-back-outer')?.files?.[0] || null,
          front_inner: document.getElementById('file-front-inner')?.files?.[0] || null,
          back_inner: document.getElementById('file-back-inner')?.files?.[0] || null,
        };

        const fd = new FormData();
        fd.append('title', (nameEl?.value || '').trim());
        fd.append('use_cover', '1');
        if (hexInput && hexInput.value) fd.append('color', hexInput.value);
        Object.entries(files).forEach(([k,v]) => { if (v) fd.append(k, v); });

        let resetLoading = true;
        try {
          const res = await fetch('/api/my-songbooks', { method: 'POST', body: fd });
          if (!res.ok) {
            const msg = await res.text();
            alert('Vytvoření selhalo: ' + (msg || res.status));
            return;
          }
          // Success: reload to show the new songbook
          window.location.reload();
          resetLoading = false;
          return;
        } catch (e) {
          alert('Chyba při komunikaci se serverem');
        } finally {
          if (resetLoading) {
            toggleButtonLoading(nbCreateBtn, null, false);
            toggleButtonLoading(nbSaveTopBtn, nbSaveTopSpinner, false);
          }
        }
      });
    }

    // Top-right Save triggers same action as nb-create
    if (nbSaveTopBtn && nbCreateBtn) {
      nbSaveTopBtn.addEventListener('click', (e) => {
        if (nbSaveTopBtn.dataset.loading === '1') return;
        e.preventDefault();
        e.stopPropagation();
        nbCreateBtn.click();
      });
    }

    // Delete songbook buttons
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.getAttribute('data-book-id');
        if (!id) return;
        const ok = await window.showConfirm('Opravdu chcete smazat tento zpěvník?', 'Odstranit');
        if (!ok) return;
        try {
          const res = await fetch(`/api/my-songbooks/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if (!res.ok) {
            const msg = await res.text();
            alert('Smazání selhalo: ' + (msg || res.status));
            return;
          }
          window.location.reload();
        } catch (_) {
          alert('Chyba při komunikaci se serverem');
        }
      });
    });

    function setShareFeedback(message, type) {
      if (!shareFeedback) return;
      shareFeedback.textContent = message || '';
      shareFeedback.classList.remove('error', 'success');
      if (type) shareFeedback.classList.add(type);
    }

    function openShareModalFor(button) {
      if (!shareModal) return;
      const id = button.getAttribute('data-book-id');
      if (!id) return;
      const title = button.getAttribute('data-book-title') || '';
      shareModal.dataset.bookId = id;
      shareModal.style.display = 'flex';
      shareModal.setAttribute('aria-hidden', 'false');
      if (shareTitleEl) shareTitleEl.textContent = title || 'tento zpěvník';
      if (shareEmailInput) {
        shareEmailInput.value = '';
        try { shareEmailInput.focus(); } catch (_) {}
      }
      if (shareSubmitBtn) {
        shareSubmitBtn.disabled = false;
        shareSubmitBtn.textContent = 'Sdílet';
      }
      setShareFeedback('', null);
    }

    function closeShareModal() {
      if (!shareModal) return;
      shareModal.style.display = 'none';
      shareModal.setAttribute('aria-hidden', 'true');
      delete shareModal.dataset.bookId;
      setShareFeedback('', null);
    }

    document.querySelectorAll('.btn-share').forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        openShareModalFor(btn);
      });
    });

    if (shareCancelBtn) {
      shareCancelBtn.addEventListener('click', (event) => {
        event.preventDefault();
        closeShareModal();
      });
    }

    if (shareModal) {
      shareModal.addEventListener('click', (event) => {
        if (event.target === shareModal) {
          closeShareModal();
        }
      });
      shareModal.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeShareModal();
        }
      });
    }

    async function submitShareRequest() {
      if (!shareModal || !shareSubmitBtn || !shareEmailInput) return;
      const id = shareModal.dataset.bookId;
      if (!id) return;
      const email = (shareEmailInput.value || '').trim();
      if (!email) {
        setShareFeedback('Zadej e-mail uživatele.', 'error');
        shareEmailInput.focus();
        return;
      }

      const restoreText = shareSubmitBtn.textContent;
      shareSubmitBtn.disabled = true;
      shareSubmitBtn.textContent = 'Sdílím…';
      setShareFeedback('', null);

      try {
        const res = await fetch(`/api/my-songbooks/${encodeURIComponent(id)}/share`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        let data = null;
        try {
          data = await res.json();
        } catch (_) {
          data = null;
        }

        if (!res.ok || !data || data.ok !== true) {
          const msg = (data && (data.error || data.message)) || 'Sdílení se nezdařilo.';
          setShareFeedback(msg, 'error');
          return;
        }

        const message = (data && data.message) || 'Zpěvník byl úspěšně sdílen.';
        setShareFeedback(message, 'success');
        if (shareEmailInput) {
          shareEmailInput.value = '';
          shareEmailInput.focus();
        }
        return;
      } catch (err) {
        setShareFeedback('Sdílení se nezdařilo. Zkus to prosím znovu.', 'error');
      } finally {
        shareSubmitBtn.disabled = false;
        shareSubmitBtn.textContent = restoreText;
      }
    }

    if (shareSubmitBtn) {
      shareSubmitBtn.addEventListener('click', (event) => {
        event.preventDefault();
        submitShareRequest();
      });
    }

    if (shareEmailInput) {
      shareEmailInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          submitShareRequest();
        }
      });
    }

    // ------- Edit mode reusing create modal -------
    window.__editMode = false;
    window.__editBookId = null;
    window.__pendingNewSongs = new Map();

    function generateTempRowId(prefix = 'tmp') {
      return `${prefix}_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 8)}`;
    }

    function ensureRowStableId(tr) {
      if (!tr) return null;
      let tid = tr.getAttribute('data-temp-id');
      if (!tid) {
        tid = generateTempRowId('row');
        tr.setAttribute('data-temp-id', tid);
      }
      return tid;
    }

    function computeSongOrderSignature() {
      const tbody = document.getElementById('eb-songs');
      if (!tbody) return [];
      return Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const sid = tr.getAttribute('data-song-id');
        if (sid && sid !== 'null') return sid;
        return ensureRowStableId(tr);
      });
    }

    function cleanupPendingNewSongs(currentOrder) {
      if (!window.__pendingNewSongs || !window.__pendingNewSongs.size) return;
      const orderSet = new Set(currentOrder);
      Array.from(window.__pendingNewSongs.keys()).forEach(key => {
        if (!orderSet.has(key)) {
          window.__pendingNewSongs.delete(key);
        }
      });
    }

    function captureEditInitialStateFromCreate() {
      try {
        const titleVal = (document.getElementById('nb-name')?.value || '').trim();
        const colorVal = (document.getElementById('hex-col')?.value || '').trim();
        const orderInit = computeSongOrderSignature();
        window.__editInitialState = { title: titleVal, color: colorVal, order: orderInit };
      } catch(_) {
        window.__editInitialState = null;
      }
    }

    function captureEditInitialStateFromClassic() {
      try {
        const titleVal = (document.getElementById('eb-name')?.value || '').trim();
        const colorVal = (document.getElementById('eb-color')?.value || '').trim();
        const orderInit = computeSongOrderSignature();
        window.__editInitialState = { title: titleVal, color: colorVal, order: orderInit };
      } catch(_) {
        window.__editInitialState = null;
      }
    }

    function hasEditModeChanges() {
      const rows = Array.from(document.getElementById('eb-songs')?.querySelectorAll('tr') || []);
      const currentOrder = computeSongOrderSignature();
      cleanupPendingNewSongs(currentOrder);
      const titleVal = (document.getElementById('nb-name')?.value || '').trim();
      const colorVal = (document.getElementById('hex-col')?.value || '').trim().toLowerCase();
      const init = window.__editInitialState || null;
      let changed = false;
      if (init) {
        if (titleVal !== (init.title || '')) changed = true;
        if (!changed && colorVal !== (init.color || '').toLowerCase()) changed = true;
        if (!changed) {
          const initOrder = init.order || [];
          if (currentOrder.length !== initOrder.length) changed = true;
          else {
            for (let i = 0; i < currentOrder.length; i += 1) {
              if (currentOrder[i] !== initOrder[i]) { changed = true; break; }
            }
          }
        }
      }
      if (!changed) {
        const fileIds = ['file-front-outer','file-front-inner','file-back-inner','file-back-outer'];
        changed = fileIds.some(id => {
          const inp = document.getElementById(id);
          return !!(inp && inp.files && inp.files.length);
        });
      }
      if (!changed) {
        changed = ['front_outer','front_inner','back_inner','back_outer']
          .some(key => document.getElementById('erem-' + key)?.value === '1');
      }
      if (!changed && rows.some(tr => tr.getAttribute('data-new-song') === '1' || tr.getAttribute('data-non-song') === '1')) {
        changed = true;
      }
      if (!changed) {
        const pendingDeletes = window.__pendingSongDeletes;
        if (pendingDeletes && pendingDeletes.size) changed = true;
      }
      if (!changed) {
        const pendingNew = window.__pendingNewSongs;
        if (pendingNew && pendingNew.size) {
          const orderSet = new Set(currentOrder);
          const active = Array.from(pendingNew.keys()).some(key => orderSet.has(key));
          if (active) changed = true;
        }
      }
      if (!changed) {
        const flagged = !!window.__editDirtyConfirm;
        if (flagged) window.__editDirtyConfirm = false;
      }
      return changed;
    }

    function hasClassicEditChanges() {
      const rows = Array.from(document.getElementById('eb-songs')?.querySelectorAll('tr') || []);
      const currentOrder = computeSongOrderSignature();
      cleanupPendingNewSongs(currentOrder);
      const titleVal = (document.getElementById('eb-name')?.value || '').trim();
      const colorVal = (document.getElementById('eb-color')?.value || '').trim().toLowerCase();
      const init = window.__editInitialState || null;
      let changed = false;
      if (init) {
        if (titleVal !== (init.title || '')) changed = true;
        if (!changed && colorVal !== (init.color || '').toLowerCase()) changed = true;
        if (!changed) {
          const initOrder = init.order || [];
          if (currentOrder.length !== initOrder.length) changed = true;
          else {
            for (let i = 0; i < currentOrder.length; i += 1) {
              if (currentOrder[i] !== initOrder[i]) { changed = true; break; }
            }
          }
        }
      }
      if (!changed) {
        const coverIds = ['efile-front-outer','efile-front-inner','efile-back-inner','efile-back-outer'];
        changed = coverIds.some(id => {
          const inp = document.getElementById(id);
          return !!(inp && inp.files && inp.files.length);
        });
      }
      if (!changed) {
        changed = ['front_outer','front_inner','back_inner','back_outer']
          .some(key => document.getElementById('erem-' + key)?.value === '1');
      }
      if (!changed && rows.some(tr => tr.getAttribute('data-new-song') === '1' || tr.getAttribute('data-non-song') === '1')) {
        changed = true;
      }
      if (!changed) {
        const pendingDeletes = window.__pendingSongDeletes;
        if (pendingDeletes && pendingDeletes.size) changed = true;
      }
      if (!changed) {
        const flagged = !!window.__editDirtyConfirm;
        if (flagged) window.__editDirtyConfirm = false;
      }
      return changed;
    }

    function escapeHtmlLite(value) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(value || '').replace(/[&<>"']/g, ch => map[ch] || ch);
    }

    function ensureEditSection(modalContent) {
      if (document.getElementById('edit-songs-section')) return;
      const section = document.createElement('div');
      section.id = 'edit-songs-section';
      section.innerHTML = `
        <div class=\"section-head\" style=\"display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 6px;\">\n          <h3 class=\"section-title\" style=\"margin: 0;\">Písničky</h3>\n          <div class=\"right-actions\" style=\"display:flex; align-items:center; gap:8px;\">\n            <button class=\"btn\" id=\"btn-add-blank-page-nb\">Přidat prázdnou stránku</button>\n            <button class=\"btn primary\" id=\"btn-add-custom-song-nb\">Přidat svou písničku</button>\n          </div>\n        </div>
        <div class="songs-list" style="margin-top:12px; border:1px solid var(--muted-border, #dbeadf); border-radius:10px; overflow:visible;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style=\"width:36px; padding:10px 12px;\">&nbsp;</th>
                <th style=\"padding:10px 12px;\">Název</th>
                <th style=\"padding:10px 12px;\">Autor</th>
                <th style=\"width:180px; padding:10px 12px; text-align:center;\">Strana</th>
                <th class=\"action-col\" style=\"width:60px; padding:10px 12px; text-align:center;\">Odebrat</th>
              </tr>
            </thead>
            <tbody id=\"eb-songs\"></tbody>
          </table>
        </div>`;
      modalContent.appendChild(section);
    }

    function renderEditRow(s) {
      const tr = document.createElement('tr');
      tr.setAttribute('data-song-id', s.song_id);
      if (s.is_private) tr.setAttribute('data-private', '1');
      tr.setAttribute('data-page-count', String(s.page_count || 1));
      tr.setAttribute('draggable', 'true');
      if (s.pending) tr.setAttribute('data-new-song', '1');
      const titleHtml = `${s.title || ''}${s.pending ? ' <span class="pending-pill">Nová</span>' : ''}`;
      tr.innerHTML = `
        <td class="drag-handle" title="Přetáhnout">≡</td>
        <td>${titleHtml}</td>
        <td>${s.author || ''}</td>
        <td class="page-span"></td>
        <td class="action-cell">
          <span class="tooltip" data-tooltip="Odstranit ze zpěvníku">
            <button class="row-action btn-row-delete" aria-label="Odstranit">
              <img src="${"{{ static_bust('img/icons/remove-song.svg') }}"}" alt="Odebrat">
            </button>
          </span>
        </td>
      `;
      return tr;
    }

    function renderBlankEditRow() {
      const tr = document.createElement('tr');
      tr.setAttribute('data-page-count', '1');
      tr.setAttribute('data-non-song', '1');
      tr.setAttribute('draggable', 'true');
      tr.setAttribute('data-temp-id', generateTempRowId('blank'));
      tr.innerHTML = `
        <td class="drag-handle" title="Přetáhnout">≡</td>
        <td>&lt;Prázdná strana&gt;</td>
        <td>-</td>
        <td class="page-span"></td>
        <td class="action-cell">
          <span class="tooltip" data-tooltip="Odstranit ze zpěvníku">
            <button class="row-action btn-row-delete" aria-label="Odstranit">
              <img src="${"{{ static_bust('img/icons/remove-song.svg') }}"}" alt="Odebrat">
            </button>
          </span>
        </td>`;
      return tr;
    }

    function wireEditDrag() {
      const ebSongs = document.getElementById('eb-songs');
      if (!ebSongs) return;
      let dragEl = null;
      ebSongs.querySelectorAll('tr').forEach(tr => {
        tr.addEventListener('dragstart', (e) => { dragEl = tr; tr.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        tr.addEventListener('dragend', () => { if (dragEl) tr.classList.remove('dragging'); dragEl = null; updateDisplayPages(); try { createDirty = true; } catch(_) {} });
        tr.addEventListener('dragover', (e) => { e.preventDefault(); const target = e.currentTarget; if (!dragEl || dragEl === target) return; const rect = target.getBoundingClientRect(); const after = (e.clientY - rect.top) > rect.height/2; ebSongs.insertBefore(dragEl, after ? target.nextSibling : target); });
      });
    }

    function wireEditRowActions() {
      const ebSongs = document.getElementById('eb-songs');
      if (!ebSongs) return;
      ebSongs.querySelectorAll('.btn-row-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          const tr = btn.closest('tr'); if (!tr) return;
          const sid = tr.getAttribute('data-song-id');
          const isNew = tr.getAttribute('data-new-song') === '1';
          if (isNew) {
            try { if (sid && window.__pendingNewSongs && typeof window.__pendingNewSongs.delete === 'function') window.__pendingNewSongs.delete(sid); } catch(_) {}
          } else {
            // Stage deletion; actual DB changes occur on Save
            try {
              window.__pendingSongDeletes = window.__pendingSongDeletes || new Set();
              if (sid) window.__pendingSongDeletes.add(sid);
            } catch(_) {}
          }
          tr.remove();
          try { updateDisplayPages(); } catch(_) {}
          try { createDirty = true; } catch(_) {}
          window.__editDirtyConfirm = true;
        });
      });
    }

    // Add blank page in re-use edit section (within new-book modal)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'btn-add-blank-page-nb') {
        e.preventDefault();
        const tbody = document.getElementById('eb-songs');
        if (!tbody) return;
        const tr = renderBlankEditRow();
        tbody.appendChild(tr);
        updateDisplayPages();
        wireEditDrag();
        wireEditRowActions();
        window.__editDirtyConfirm = true;
      }
    });

    // ---------- New custom song modal ----------
    const nsModal = document.getElementById('new-song-modal');
    const nsFilesWrap = document.getElementById('ns-files');
    const nsPages = document.getElementById('ns-pages');
    const nsTitle = document.getElementById('ns-title-input');
    const nsAuthor = document.getElementById('ns-author-input');
    const nsSave = document.getElementById('ns-save');
    const nsCancel = document.getElementById('ns-cancel');
    const nsHover = document.getElementById('ns-hover-preview');

    // Persist selected files across re-render
    let nsSelected = {};
    function snapshotSelected(n) {
      const res = {};
      for (let i=1;i<=n;i++) {
        const el = document.getElementById(`ns-file-${i}`);
        if (el && el.files && el.files[0]) res[i] = el.files[0];
      }
      return res;
    }

    function applyFileToInput(input, file, prevImg) {
      try {
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
      } catch(_) { /* ignore */ }
    }

    function revokePreview(img) {
      if (!img) return;
      const prevUrl = img.getAttribute('data-url');
      if (prevUrl) {
        try { URL.revokeObjectURL(prevUrl); } catch(_) {}
        img.removeAttribute('data-url');
      }
    }

    function updateDropzoneState(dz, lab, defaultText, file, prev) {
      if (!dz || !lab || !prev) return;
      if (file) {
        revokePreview(prev);
        const url = URL.createObjectURL(file);
        prev.src = url;
        prev.setAttribute('data-url', url);
        prev.style.display = 'block';
        lab.textContent = file.name;
        lab.style.fontWeight = '700';
        dz.classList.add('filled');
      } else {
        revokePreview(prev);
        prev.removeAttribute('src');
        prev.style.display = 'none';
        lab.textContent = defaultText;
        lab.style.fontWeight = '600';
        dz.classList.remove('filled');
      }
    }

    function renderNsInputs(count, preserveSelections = true) {
      // snapshot existing before rebuild (optional)
      Array.from(nsFilesWrap.querySelectorAll('img[data-url]')).forEach(revokePreview);
      if (preserveSelections) {
        try { nsSelected = snapshotSelected(20); } catch(_) {}
      } else {
        nsSelected = {};
      }
      nsFilesWrap.innerHTML = '';
      const c = Math.max(1, Math.min(20, parseInt(count||'1',10)||1));
      for (let i=1;i<=c;i++) {
        const row = document.createElement('div');
        row.className = 'ns-file';
        row.innerHTML = `
          <label class=\"dropzone ns-dz\" for=\"ns-file-${i}\"><span class=\"dz-label\">Klikni nebo přetáhni obrázek sem (strana ${i})</span></label>
          <div class=\"ns-prev\"><img id=\"ns-prev-${i}\" alt=\"Náhled ${i}\"/></div>
          <input type=\"file\" id=\"ns-file-${i}\" accept=\"image/*\" style=\"display:none;\">
        `;
        nsFilesWrap.appendChild(row);
        const input = row.querySelector(`#ns-file-${i}`);
        const dz = row.querySelector('label.dropzone');
        const lab = dz.querySelector('.dz-label');
        const defaultText = `Klikni nebo přetáhni obrázek sem (strana ${i})`;
        const prev = row.querySelector(`#ns-prev-${i}`);
        dz.addEventListener('click', () => input.click());
        input.addEventListener('change', () => {
          const f = input.files && input.files[0];
          notifyIfLargeFile(f);
          if (f) nsSelected[i] = f; else delete nsSelected[i];
          updateDropzoneState(dz, lab, defaultText, f, prev);
          checkNsValidity();
        });
        ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e)=>{e.preventDefault(); dz.style.background='#f1f1f1';}));
        ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e)=>{e.preventDefault(); dz.style.background='';}));
        dz.addEventListener('drop', (e)=>{ const files=e.dataTransfer.files; if(files&&files.length){ input.files=files; input.dispatchEvent(new Event('change')); }});
        // Restore previous file if existed and still within range
        if (preserveSelections && nsSelected[i]) {
          try { applyFileToInput(input, nsSelected[i], prev); } catch(_) {}
          updateDropzoneState(dz, lab, defaultText, nsSelected[i], prev);
        } else {
          updateDropzoneState(dz, lab, defaultText, null, prev);
        }
        // Hover large preview
        function attachHover(el) {
          el.addEventListener('mouseenter', (ev)=>{
            const src = prev.getAttribute('src'); if (!src || !nsHover) return;
            nsHover.style.display = 'block'; nsHover.querySelector('img').src = src;
          });
          el.addEventListener('mousemove', (ev)=>{
            if (!nsHover || nsHover.style.display !== 'block') return;
            const x = Math.min(window.innerWidth - 300, ev.clientX + 16);
            const y = Math.min(window.innerHeight - 360, ev.clientY + 16);
            nsHover.style.left = x + 'px'; nsHover.style.top = y + 'px';
          });
          el.addEventListener('mouseleave', ()=>{ if (nsHover) nsHover.style.display='none'; });
        }
        attachHover(prev.parentElement);
        attachHover(dz);
      }
      checkNsValidity();
    }

    function openNewSongModal() {
      if (!nsModal) return;
      resetNewSongForm();
      nsModal.style.display = 'flex';
    }

    function resetNewSongForm() {
      if (!nsModal) return;
      nsTitle.value = '';
      nsAuthor.value = '';
      nsPages.value = 1;
      nsSelected = {};
      renderNsInputs(1, false);
      checkNsValidity();
      if (nsHover) nsHover.style.display = 'none';
    }

    function closeNewSongModal(reset = true) {
      if (nsModal) nsModal.style.display='none';
      if (reset) resetNewSongForm();
    }

    function checkNsValidity() {
      // At least one page file must be present
      let has = false;
      const n = Math.max(1, Math.min(20, parseInt(nsPages.value||'1',10)||1));
      for (let i=1;i<=n;i++) { const el = document.getElementById(`ns-file-${i}`); if (el && el.files && el.files.length) { has = true; break; } }
      nsSave.disabled = !has;
    }

    if (nsPages) nsPages.addEventListener('input', () => { renderNsInputs(nsPages.value, true); });
    if (nsCancel) nsCancel.addEventListener('click', () => closeNewSongModal(true));

    // Hook buttons in both editors
    document.addEventListener('click', (e) => {
      const id = e.target && e.target.id;
      if (id === 'btn-add-custom-song-eb' || id === 'btn-add-custom-song-nb') {
        e.preventDefault(); openNewSongModal();
      }
    });

    async function refreshEditSongs(bookId) {
      const ebSongs = document.getElementById('eb-songs');
      if (!ebSongs) {
        window.location.reload();
        return;
      }
      window.__pendingNewSongs = new Map();
      try {
        const res = await fetch(`/api/my-songbooks/${encodeURIComponent(bookId)}/structure`);
        if (!res.ok) throw new Error('Fetch failed');
        const data = await res.json();
        if (!data || !data.ok) throw new Error('Invalid payload');
        const songs = (data.songbook && data.songbook.songs) || [];
        ebSongs.innerHTML = '';
        songs.forEach(s => ebSongs.appendChild(renderEditRow(s)));
        updateDisplayPages();
        wireEditDrag();
        wireEditRowActions();
        try {
          if (window.__pendingSongDeletes && typeof window.__pendingSongDeletes.clear === 'function') {
            window.__pendingSongDeletes.clear();
          } else {
            window.__pendingSongDeletes = new Set();
          }
        } catch(_) { window.__pendingSongDeletes = new Set(); }
        captureEditInitialStateFromCreate();
        window.__editDirtyConfirm = false;
      } catch (err) {
        console.error('Failed to refresh song list', err);
        window.location.reload();
      }
    }

    if (nsSaveBtn) {
      nsSaveBtn.addEventListener('click', async () => {
        if (nsSaveBtn.disabled || nsSaveBtn.dataset.loading === '1') return;
        toggleButtonLoading(nsSaveBtn, nsSaveSpinner, true, 'Ukládám…');
        await new Promise((resolve) => requestAnimationFrame(resolve));
        const tbody = document.getElementById('eb-songs');
        if (!tbody) { alert('Chybí seznam písniček'); toggleButtonLoading(nsSaveBtn, nsSaveSpinner, false); return; }
        const titleRaw = (nsTitle.value || '').trim() || 'Moje písnička';
        const authorRaw = (nsAuthor.value || '').trim() || '-';
        const n = Math.max(1, Math.min(20, parseInt(nsPages.value || '1', 10) || 1));
        const files = [];
        for (let i = 1; i <= n; i++) {
          const el = document.getElementById(`ns-file-${i}`);
          if (el && el.files && el.files[0]) {
            files.push(el.files[0]);
          }
        }
        if (!files.length) { toggleButtonLoading(nsSaveBtn, nsSaveSpinner, false); return; }
        if (!window.__pendingNewSongs || typeof window.__pendingNewSongs.set !== 'function') {
          window.__pendingNewSongs = new Map();
        }
        const tempId = `__new_${Date.now().toString(36)}${Math.random().toString(36).slice(2, 8)}`;
        window.__pendingNewSongs.set(tempId, {
          title: titleRaw,
          author: authorRaw,
          page_count: files.length,
          files
        });
        const displayTitle = escapeHtmlLite(titleRaw);
        const displayAuthor = escapeHtmlLite(authorRaw);
        const row = renderEditRow({
          song_id: tempId,
          title: displayTitle,
          author: displayAuthor,
          page_count: files.length,
          is_private: true,
          pending: true
        });
        tbody.appendChild(row);
        updateDisplayPages();
        wireEditDrag();
        wireEditRowActions();
        window.__editDirtyConfirm = true;
        try { createDirty = true; } catch(_) {}
        toggleButtonLoading(nsSaveBtn, nsSaveSpinner, false);
        closeNewSongModal(true);
      });
    }

    function updateDisplayPages() {
      const ebSongs = document.getElementById('eb-songs');
      if (!ebSongs) return;
      let next = 1;
      Array.from(ebSongs.querySelectorAll('tr')).forEach(tr => {
        const pageCount = parseInt(tr.getAttribute('data-page-count') || '1', 10) || 1;
        const cell = tr.querySelector('.page-span');
        const start = next;
        let txt = '';
        if (pageCount <= 1) {
          txt = String(start);
        } else if (pageCount <= 3) {
          const extras = Array.from({length: pageCount - 1}, (_, i) => start + i + 1);
          txt = `${start} (${extras.join(',')})`;
        } else {
          const last = start + pageCount - 1;
          txt = `${start} (${start+1},...,${last})`;
        }
        if (cell) cell.textContent = txt;
        next += pageCount;
      });
    }

    window.openEditSongbookModal = (bookId) => {
      window.__editMode = true; window.__editBookId = bookId;
      window.__pendingNewSongs = new Map();
      const title = document.getElementById('nb-title'); if (title) title.textContent = 'Upravit zpěvník';
      const primary = document.getElementById('nb-create'); if (primary) primary.textContent = 'Uložit';
      resetUploads();
      // Reset re-use removal flags
      try { ['front_outer','front_inner','back_inner','back_outer'].forEach(k => { const el = document.getElementById('erem-' + k); if (el) el.value = '0'; }); } catch(_) {}
      openCreateModal();
      ensureEditSection(modalContent);
      const ebSongs = document.getElementById('eb-songs'); if (ebSongs) ebSongs.innerHTML = '';
      fetch(`/api/my-songbooks/${encodeURIComponent(bookId)}/structure`).then(r=>r.json()).then(data => {
        if (!data || !data.ok) return;
        const sb = data.songbook || {};
        const nameEl = document.getElementById('nb-name'); if (nameEl) nameEl.value = sb.title || '';
        const hexInput = document.getElementById('hex-col');
        if (hexInput) {
          hexInput.value = (sb.color || '#ffffff');
          // Update preview color without firing input handlers that mark dirty
          try { const c = hexToRgb(hexInput.value); if (c) applyColor(c.r, c.g, c.b); } catch(_) {}
        }
        const covers = sb.covers || {};
        const map = [
          ['dz-front-outer','tex-front-outer','front_outer','front_outer_name'],
          ['dz-front-inner','tex-front-inner','front_inner','front_inner_name'],
          ['dz-back-inner','tex-back-inner','back_inner','back_inner_name'],
          ['dz-back-outer','tex-back-outer','back_outer','back_outer_name'],
        ];
        map.forEach(([dzId, faceId, keyPath, keyName]) => {
          const dz = document.getElementById(dzId);
          const lab = dz ? dz.querySelector('.dz-label') : null;
          if (lab && covers[keyName]) { lab.textContent = covers[keyName]; lab.style.fontWeight='700'; dz.classList.add('filled'); }
          const face = document.getElementById(faceId);
          if (face && covers[keyPath]) face.style.backgroundImage = `url('/songbooks/${covers[keyPath]}')`;
        });
        if (ebSongs) {
          (sb.songs||[]).forEach(s => ebSongs.appendChild(renderEditRow(s)));
          wireEditDrag();
          updateDisplayPages();
          wireEditRowActions();
        }
        // Ensure create/edit dirty flag remains clean after initial populate
        try { createDirty = false; } catch(_) {}
        // Capture initial state for dirty checks on close
        captureEditInitialStateFromCreate();
      });
    };

    // Intercept primary button when in edit mode
    if (nbCreateBtn) {
      nbCreateBtn.addEventListener('click', async (e) => {
        if (!window.__editMode) return; // let create handler run
        e.preventDefault(); e.stopPropagation();
        if (nbCreateBtn.dataset.loading === '1') return;
        toggleButtonLoading(nbCreateBtn, null, true, 'Ukládám…');
        toggleButtonLoading(nbSaveTopBtn, nbSaveTopSpinner, true, 'Ukládám…');
        const tbody = document.getElementById('eb-songs');
        const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
        const order = rows.map(tr => {
          const sid = tr.getAttribute('data-song-id');
          if (sid) return { song_id: sid };
          if (tr.getAttribute('data-non-song') === '1') return { non_song: true };
          return null;
        }).filter(Boolean);
        cleanupPendingNewSongs(computeSongOrderSignature());
        const fd = new FormData();
        fd.append('title', (document.getElementById('nb-name').value||'').trim());
        const hex = (document.getElementById('hex-col') && document.getElementById('hex-col').value) || '#ffffff';
        fd.append('color', hex);
        fd.append('auto_numbering', '1');
        const pendingNewSongs = [];
        const pendingNewMap = (window.__pendingNewSongs && typeof window.__pendingNewSongs.forEach === 'function') ? window.__pendingNewSongs : null;
        if (pendingNewMap) {
          pendingNewMap.forEach((meta, tempId) => {
            if (!meta || !tempId) return;
            pendingNewSongs.push({
              temp_id: tempId,
              title: meta.title || '',
              author: meta.author || '',
              page_count: meta.page_count || (meta.files ? meta.files.length : 0)
            });
          });
        }
        try {
          if (window.__pendingSongDeletes && window.__pendingSongDeletes.size) {
            const deletions = Array.from(window.__pendingSongDeletes).filter(sid => sid && !String(sid).startsWith('__new_'));
            if (deletions.length) fd.append('delete_songs', JSON.stringify(deletions));
          }
        } catch(_) {}
        // Cover removal flags (re-use edit in this modal)
        try {
          ['front_outer','front_inner','back_inner','back_outer'].forEach(key => {
            const v = document.getElementById('erem-' + key)?.value;
            if (v === '1') fd.append('remove_' + key, '1');
          });
        } catch(_) {}
        fd.append('order', JSON.stringify(order));
        const files = {
          front_outer: document.getElementById('file-front-outer'),
          front_inner: document.getElementById('file-front-inner'),
          back_inner: document.getElementById('file-back-inner'),
          back_outer: document.getElementById('file-back-outer')
        };
        Object.entries(files).forEach(([k,inp]) => { if (inp && inp.files && inp.files[0]) fd.append(k, inp.files[0]); });
        if (pendingNewSongs.length) {
          fd.append('new_songs', JSON.stringify(pendingNewSongs));
          pendingNewSongs.forEach(item => {
            if (!item || !item.temp_id) return;
            const meta = pendingNewMap ? pendingNewMap.get(item.temp_id) : null;
            if (!meta || !meta.files || !meta.files.length) return;
            meta.files.forEach((file, idx) => {
              const fieldName = `new_song_${item.temp_id}_page_${idx+1}`;
              fd.append(fieldName, file);
            });
          });
        }
        let resetLoading = true;
        try {
          const res = await fetch(`/api/my-songbooks/${encodeURIComponent(window.__editBookId)}/structure`, { method: 'POST', body: fd });
          if (!res.ok) { const t = await res.text(); alert('Uložení selhalo: ' + (t || res.status)); return; }
          window.location.reload();
          resetLoading = false;
          return;
        } catch (_) { alert('Chyba při ukládání'); } finally {
          if (resetLoading) {
            toggleButtonLoading(nbCreateBtn, null, false);
            toggleButtonLoading(nbSaveTopBtn, nbSaveTopSpinner, false);
          }
        }
      }, true);
    }

    // Removed duplicate nb-cancel handler that reset layout prematurely during confirm
  });
  </script>
  <script>
  // Fallback in case main script fails earlier: ensure edit modal can open
  (function(){
    if (window.openEditSongbookModal) return;
    window.openEditSongbookModal = function(bookId){
      try {
        var modal = document.getElementById('edit-book-modal');
        var ebName = document.getElementById('eb-name');
        var ebColor = document.getElementById('eb-color');
        var ebSongs = document.getElementById('eb-songs');
        if (!modal) return;
        modal.style.display = 'flex';
        if (ebSongs) ebSongs.innerHTML = '';
        fetch('/api/my-songbooks/' + encodeURIComponent(bookId) + '/structure')
          .then(function(r){ return r.json(); })
          .then(function(data){
            if (!data || !data.ok) return;
            var sb = data.songbook || {};
            if (ebName) ebName.value = sb.title || '';
            if (ebColor) ebColor.value = sb.color || '#ffffff';
            var covers = sb.covers || {};
            var map = {
              front_outer: 'elab-front-outer',
              front_inner: 'elab-front-inner',
              back_inner: 'elab-back-inner',
              back_outer: 'elab-back-outer'
            };
            Object.keys(map).forEach(function(k){
              var labId = map[k];
              var nameKey = k.replace(/^(.*)$/,'$1') + '_name';
              var el = document.getElementById(labId);
              if (el && covers[nameKey]) el.textContent = covers[nameKey];
            });
            if (ebSongs) {
              (sb.songs || []).forEach(function(s){
                var tr = document.createElement('tr');
                tr.innerHTML = '<td title="Přetáhnout">≡</td>'+
                               '<td>'+(s.title||'')+'</td>'+
                               '<td>'+(s.author||'')+'</td>'+
                               '<td class="center"><input class="page-input eb-start" type="number" min="1" value="'+(s.start_page||1)+'"></td>'+
                               '<td>'+(s.page_count||1)+'</td>'+
                               '<td class="action-cell">'+
                                 '<span class="tooltip" data-tooltip="Odstranit ze zpěvníku">'+
                                   '<button class="row-action btn-row-delete" aria-label="Odstranit">'+
                                   '<img src="{{ static_bust('"'"'img/icons/remove-song.svg'"'"') }}" alt="Odebrat">'+
                                   '</button>'+
                                 '</span>'+
                               '</td>';
                ebSongs.appendChild(tr);
              });
            }
          })
          .catch(function(){});
      } catch(e){}
    };
  })();
  </script>
{% endblock %}
    // ------- Edit songbook modal -------
    const editModal = document.getElementById('edit-book-modal');
    const ebName = document.getElementById('eb-name');
    const ebColor = document.getElementById('eb-color');
    const ebAuto = document.getElementById('eb-auto');
    const ebSongs = document.getElementById('eb-songs');
    const efiles = {
      front_outer: document.getElementById('efile-front-outer'),
      front_inner: document.getElementById('efile-front-inner'),
      back_inner: document.getElementById('efile-back-inner'),
      back_outer: document.getElementById('efile-back-outer')
    };
    const elabs = {
      front_outer: document.getElementById('elab-front-outer'),
      front_inner: document.getElementById('elab-front-inner'),
      back_inner: document.getElementById('elab-back-inner'),
      back_outer: document.getElementById('elab-back-outer')
    };

    function bindDrop(idInput, idDz, idLab, targetFaceId) {
      const input = document.getElementById(idInput);
      const dz = document.getElementById(idDz);
      const label = document.getElementById(idLab);
      const handleFiles = (files) => {
        if (!files || !files[0]) return;
        const f = files[0];
        notifyIfLargeFile(f);
        if (label) { label.textContent = f.name; label.style.fontWeight = '700'; }
        dz.classList.add('filled');
        if (targetFaceId) {
          const face = document.getElementById(targetFaceId);
          if (face) {
            const url = URL.createObjectURL(f);
            face.style.backgroundImage = `url('${url}')`;
          }
        }
      };
      dz.addEventListener('click', () => input.click());
      input.addEventListener('change', (e) => handleFiles(e.target.files));
      ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.add('hover'); }));
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e) => { e.preventDefault(); dz.classList.remove('hover'); }));
      dz.addEventListener('drop', (e) => { const files = e.dataTransfer.files; if (files && files.length) { input.files = files; handleFiles(files); } });

      // Clear button for edit dropzone
      const clearBtnId = idInput.replace('efile-', 'eclear-');
      const clearBtn = document.getElementById(clearBtnId);
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.preventDefault(); e.stopPropagation();
          if (input) input.value = '';
          if (label) { label.textContent = 'Klikni nebo přetáhni obrázek sem'; label.style.fontWeight = '600'; }
          if (dz) dz.classList.remove('filled');
          if (targetFaceId) {
            const face = document.getElementById(targetFaceId);
            if (face) face.style.backgroundImage = '';
          }
          // set removal flag and mark dirty
          try {
            const key = idDz.replace(/^edz-/, '').replace(/-/g, '_'); // e.g. front_outer
            const rem = document.getElementById('erem-' + key);
            if (rem) rem.value = '1';
            window.__editDirtyConfirm = true;
          } catch(_) {}
        });
      }
    }
    bindDrop('efile-front-outer','edz-front-outer','elab-front-outer','etex-front-outer');
    bindDrop('efile-back-outer','edz-back-outer','elab-back-outer','etex-back-outer');
    bindDrop('efile-front-inner','edz-front-inner','elab-front-inner','etex-front-inner');
    bindDrop('efile-back-inner','edz-back-inner','elab-back-inner','etex-back-inner');

    let currentEditBookId = null;

    function openEditModal(bookId) {
      currentEditBookId = bookId;
      // Reset UI
      window.__editDirtyConfirm = false;
      ebName.value = '';
      ebColor.value = '#ffffff';
      // Reset removal flags
      try {
        ['erem-front_outer','erem-front_inner','erem-back_inner','erem-back_outer']
          .forEach(id => { const el = document.getElementById(id); if (el) el.value = '0'; });
      } catch(_) {}
      Object.values(elabs).forEach(l => { if (l) { l.textContent = 'Klikni nebo přetáhni obrázek sem'; l.style.fontWeight='600'; }});
      Object.values(efiles).forEach(inp => { if (inp) inp.value = ''; });
      ebSongs.innerHTML = '';
      ebAuto.checked = true;

      editModal.style.display = 'flex';

      fetch(`/api/my-songbooks/${encodeURIComponent(bookId)}/structure`)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.ok) return;
          const sb = data.songbook || {};
          ebName.value = sb.title || '';
          ebColor.value = sb.color || '#ffffff';
          // Apply book color to preview faces (as base)
          const efaces = ['etex-front-outer','etex-front-inner','etex-back-inner','etex-back-outer'];
          efaces.forEach(id => { const el = document.getElementById(id); if (el) { el.style.backgroundColor = ebColor.value; el.style.backgroundImage = ''; }});
          if (sb.covers) {
            if (sb.covers.front_outer_name) elabs.front_outer.textContent = sb.covers.front_outer_name;
            if (sb.covers.front_inner_name) elabs.front_inner.textContent = sb.covers.front_inner_name;
            if (sb.covers.back_inner_name) elabs.back_inner.textContent = sb.covers.back_inner_name;
            if (sb.covers.back_outer_name) elabs.back_outer.textContent = sb.covers.back_outer_name;
            // Set preview images if paths are available
            if (sb.covers.front_outer) { const el = document.getElementById('etex-front-outer'); if (el) el.style.backgroundImage = `url('/songbooks/${sb.covers.front_outer}')`; }
            if (sb.covers.front_inner) { const el = document.getElementById('etex-front-inner'); if (el) el.style.backgroundImage = `url('/songbooks/${sb.covers.front_inner}')`; }
            if (sb.covers.back_inner)  { const el = document.getElementById('etex-back-inner');  if (el) el.style.backgroundImage = `url('/songbooks/${sb.covers.back_inner}')`; }
            if (sb.covers.back_outer)  { const el = document.getElementById('etex-back-outer');  if (el) el.style.backgroundImage = `url('/songbooks/${sb.covers.back_outer}')`; }
            // Mark dropzones as filled so the clear icon shows
            try {
              const mapFilled = [
                ['edz-front-outer','front_outer_name'],
                ['edz-front-inner','front_inner_name'],
                ['edz-back-inner','back_inner_name'],
                ['edz-back-outer','back_outer_name'],
              ];
              mapFilled.forEach(([dzId, nameKey]) => {
                const dz = document.getElementById(dzId);
                if (dz && sb.covers[nameKey]) dz.classList.add('filled');
              });
            } catch(_) {}
          }
          // Simple continuous rotation like creation
          const ebook = document.getElementById('ebook-3d');
          if (ebook) {
            ebook.style.animation = 'spin-book 8000ms linear infinite';
          }
          // Update color preview on ebColor change
          ebColor.addEventListener('input', () => {
            efaces.forEach(id => { const el = document.getElementById(id); if (el) el.style.backgroundColor = ebColor.value; });
          }, { once: true });
          const songs = sb.songs || [];
          songs.forEach((s, idx) => ebSongs.appendChild(renderRow(s, idx)));
          wireDrag();
          applyAutoNumbering();
          wireClassicRowActions();
          captureEditInitialStateFromClassic();
          window.__editDirtyConfirm = false;
        });
    }

    // expose for inline onclick fallback
    window.openEditSongbookModal = openEditModal;

    function renderRow(s, idx) {
      const tr = document.createElement('tr');
      tr.setAttribute('data-song-id', s.song_id);
      if (s.is_private) tr.setAttribute('data-private', '1');
      tr.setAttribute('data-page-count', String(s.page_count || 1));
      tr.setAttribute('draggable', 'true');
      tr.innerHTML = `
        <td class="drag-handle" title="Přetáhnout">≡</td>
        <td>${s.title || ''}</td>
        <td>${s.author || ''}</td>
        <td class="center"><input class="page-input eb-start" type="number" min="1" value="${s.start_page||1}" disabled></td>
        <td>${s.page_count||1}</td>
        <td class="action-cell">
          <span class="tooltip" data-tooltip="Odstranit ze zpěvníku">
            <button class="row-action btn-row-delete" aria-label="Odstranit">
              <img src="${"{{ static_bust('img/icons/remove-song.svg') }}"}" alt="Odebrat">
            </button>
          </span>
        </td>
      `;
      return tr;
    }

    function wireDrag() {
      let dragEl = null;
      ebSongs.querySelectorAll('tr').forEach(tr => {
        tr.addEventListener('dragstart', (e) => { dragEl = tr; tr.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        tr.addEventListener('dragend', () => {
          if (dragEl) tr.classList.remove('dragging');
          dragEl = null;
          // Recompute numbering after reorder
          applyAutoNumbering();
          // Mark edit as dirty (order changed)
          window.__editDirtyConfirm = true;
        });
        tr.addEventListener('dragover', (e) => { e.preventDefault(); const target = e.currentTarget; if (!dragEl || dragEl === target) return; const rect = target.getBoundingClientRect(); const after = (e.clientY - rect.top) > rect.height/2; ebSongs.insertBefore(dragEl, after ? target.nextSibling : target); });
      });
    }

    // Helper: create a classic-edit blank page row
    function renderBlankClassicRow() {
      const tr = document.createElement('tr');
      tr.setAttribute('data-page-count', '1');
      tr.setAttribute('data-non-song', '1');
      tr.setAttribute('draggable', 'true');
      tr.setAttribute('data-temp-id', generateTempRowId('blank'));
      tr.innerHTML = `
        <td class="drag-handle" title="Přetáhnout">≡</td>
        <td>&lt;Prázdná strana&gt;</td>
        <td>-</td>
        <td class="center"><input class="page-input eb-start" type="number" min="1" value="1" disabled></td>
        <td>1</td>
        <td class="action-cell">
          <span class="tooltip" data-tooltip="Odstranit ze zpěvníku">
            <button class="row-action btn-row-delete" aria-label="Odstranit">
              <img src="${"{{ static_bust('img/icons/remove-song.svg') }}"}" alt="Odebrat">
            </button>
          </span>
        </td>`;
      return tr;
    }

    function wireClassicRowActions() {
      ebSongs.querySelectorAll('.btn-row-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault(); e.stopPropagation();
          const tr = btn.closest('tr'); if (!tr) return;
          const sid = tr.getAttribute('data-song-id');
          const isPriv = tr.getAttribute('data-private') === '1';
          if (isPriv && window.__editBookId) {
            try {
              const res = await fetch(`/api/my-songbooks/${encodeURIComponent(window.__editBookId)}/songs/${encodeURIComponent(sid)}`, { method: 'DELETE' });
              if (!res.ok) { const t = await res.text(); alert('Mazání písničky selhalo: ' + (t || res.status)); return; }
            } catch(_) { alert('Chyba při mazání písničky'); return; }
          }
          tr.remove();
          applyAutoNumbering();
          window.__editDirtyConfirm = true;
        });
      });
    }

    // Add blank page in classic edit modal
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (!t) return;
      if (t.id === 'btn-add-blank-page-eb') {
        e.preventDefault();
        const tbody = document.getElementById('eb-songs');
        if (!tbody) return;
        const tr = renderBlankClassicRow();
        tbody.appendChild(tr);
        applyAutoNumbering();
        wireDrag();
        wireClassicRowActions();
      }
    });

    function applyAutoNumbering() {
      const rows = Array.from(ebSongs.querySelectorAll('tr'));
      const auto = ebAuto.checked;
      let next = 1;
      rows.forEach(tr => {
        const startInput = tr.querySelector('.eb-start');
        const pageCount = parseInt(tr.getAttribute('data-page-count') || '1', 10) || 1;
        if (auto) {
          startInput.value = next;
          startInput.disabled = true;
          next += pageCount;
        } else {
          startInput.disabled = false;
        }
      });
    }

    ebAuto.addEventListener('change', applyAutoNumbering);
    document.getElementById('eb-cancel').addEventListener('click', async (e) => {
      const changed = hasClassicEditChanges();
      if (changed) {
        const choice = await window.showUnsavedConfirm('Zahodit neuložené změny?');
        if (choice === 'cancel') { e.preventDefault(); e.stopPropagation(); return; }
        if (choice === 'save') { document.getElementById('eb-save')?.click(); return; }
      }
      editModal.style.display = 'none';
      window.__editDirtyConfirm = false;
      window.__pendingNewSongs = new Map();
    });
    document.getElementById('eb-save').addEventListener('click', async () => {
      if (!currentEditBookId) return;
      const rows = Array.from(ebSongs.querySelectorAll('tr'));
      const order = rows.map(tr => {
        const sid = tr.getAttribute('data-song-id');
        const sp = (tr.querySelector('.eb-start') || {}).value;
        if (sid) return { song_id: sid, start_page: sp };
        if (tr.getAttribute('data-non-song') === '1') return { non_song: true, start_page: sp };
        return null;
      }).filter(Boolean);
      const fd = new FormData();
      fd.append('title', (ebName.value||'').trim());
      fd.append('color', (ebColor.value||'').trim());
      fd.append('auto_numbering', ebAuto.checked ? '1' : '0');
      fd.append('order', JSON.stringify(order));
      // Cover removal flags
      try {
        ['front_outer','front_inner','back_inner','back_outer'].forEach(key => {
          const v = document.getElementById('erem-' + key)?.value;
          if (v === '1') fd.append('remove_' + key, '1');
        });
      } catch(_) {}
      // Optional covers
      Object.entries(efiles).forEach(([k,inp]) => { if (inp && inp.files && inp.files[0]) fd.append(k, inp.files[0]); });
      try {
        const res = await fetch(`/api/my-songbooks/${encodeURIComponent(currentEditBookId)}/structure`, { method: 'POST', body: fd });
        if (!res.ok) { const t = await res.text(); alert('Uložení selhalo: ' + (t || res.status)); return; }
        editModal.style.display = 'none';
        window.location.reload();
      } catch (e) { alert('Chyba při ukládání'); }
    });

    // Top-right Save in classic edit modal mirrors eb-save
    try {
      const ebSaveTop = document.getElementById('eb-save-top');
      const ebSaveBtn = document.getElementById('eb-save');
      if (ebSaveTop && ebSaveBtn) {
        ebSaveTop.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); ebSaveBtn.click(); });
      }
    } catch(_) {}

    // Open edit modal buttons (progressive enhancement; inline onclick also calls global)
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        const id = btn.getAttribute('data-book-id'); if (id) openEditModal(id);
      });
    });

    // Edit modal dirty tracking and overlay close with confirm
    window.__editDirtyConfirm = false;
    [document.getElementById('eb-name'), document.getElementById('eb-color')]
      .filter(Boolean).forEach(el => el.addEventListener('input', () => { window.__editDirtyConfirm = true; }));
    ['efile-front-outer','efile-front-inner','efile-back-inner','efile-back-outer']
      .map(id => document.getElementById(id)).filter(Boolean)
      .forEach(inp => inp.addEventListener('change', () => { window.__editDirtyConfirm = true; }));

    const ebContent = editModal.querySelector('.modal');
    editModal.addEventListener('click', async (e) => {
      // Treat any click outside the .modal content as overlay click
      const outside = ebContent ? !ebContent.contains(e.target) : (e.target === editModal);
      if (!outside) return;
      const changed = hasClassicEditChanges();
      if (changed) {
        const choice = await window.showUnsavedConfirm('Zahodit neuložené změny?');
        if (choice === 'cancel') { e.preventDefault(); e.stopPropagation(); return; }
        if (choice === 'save') { document.getElementById('eb-save')?.click(); return; }
      }
      editModal.style.display = 'none';
      window.__editDirtyConfirm = false;
      window.__pendingNewSongs = new Map();
    });
